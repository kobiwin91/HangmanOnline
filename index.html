
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>איש תלוי אונליין</title>

  <!-- Firebase SDK Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      background: #f5f9fc;
      color: rgba(0,0,0,0.87);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      direction: rtl;
      text-align: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      max-width: 800px;
      margin: 20px auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    h1 { 
      font-size: 28px; 
      color: #2c3e50; 
      margin-bottom: 20px;
    }
    h2 {
      font-size: 22px;
      color: #3498db;
      margin: 20px 0 15px;
    }
    p { 
      font-size: 16px; 
      margin: 12px 0; 
      color: #34495e;
    }
    input {
      width: 80%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border 0.3s;
    }
    input:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 5px rgba(52,152,219,0.5);
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      font-size: 15px;
      transition: background 0.3s, transform 0.1s;
    }
    button:hover { 
      background: #2980b9; 
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(1px);
    }
    button:disabled { 
      background: #95a5a6; 
      cursor: not-allowed; 
      transform: none;
    }
    .btn-primary {
      background: #3498db;
    }
    .btn-success {
      background: #2ecc71;
    }
    .btn-danger {
      background: #e74c3c;
    }
    .btn-warning {
      background: #f39c12;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 20px 0; 
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { 
      padding: 12px 15px; 
      text-align: center;
    }
    th { 
      background: #3498db; 
      color: white;
      font-weight: 600;
    }
    tr:nth-child(even) { 
      background: #f2f6f9; 
    }
    tr:hover {
      background: #e8f4fb;
    }
    .hidden { 
      display: none; 
    }
    #wordDisplay {
      font-size: 40px;
      letter-spacing: 8px;
      margin: 25px 0;
      white-space: pre;
      color: #2c3e50;
      min-height: 50px;
    }
    #hangmanCanvas { 
      margin: 20px auto; 
      display: block;
      border-radius: 8px;
      background: #f9f9f9;
    }
    #keyboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      max-width: 600px;
      margin: 20px auto;
    }
    #keyboard button {
      min-width: 40px;
      font-size: 18px;
    }
    #chat {
      border: 1px solid #ddd;
      height: 180px;
      overflow-y: auto;
      margin: 20px 0;
      padding: 15px;
      text-align: right;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .chat-message {
      margin: 8px 0;
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 80%;
      word-wrap: break-word;
      position: relative;
      clear: both;
      background: #e8f4fb;
      float: right;
    }
    .chat-message.system {
      background: #e9ebef;
      color: #7f8c8d;
      margin: 5px auto;
      float: none;
      text-align: center;
      font-style: italic;
      font-size: 14px;
    }
    .chat-message.other {
      background: #efffef;
      float: left;
    }
    .chat-name {
      font-weight: bold;
      margin-bottom: 3px;
      color: #2980b9;
    }
    .chat-name.other {
      color: #27ae60;
    }
    #timerDisplay {
      font-size: 20px;
      margin: 10px 0;
      color: #e74c3c;
      font-weight: bold;
    }
    .round-info {
      display: flex;
      justify-content: space-around;
      margin: 15px auto;
      max-width: 500px;
      background: #f2f6f9;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
    }
    .game-counter {
      background: #3498db;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 5px;
    }
    .lobby-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .lobby-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .invite-link {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 5px;
      border: 1px dashed #ddd;
      font-size: 14px;
      margin: 10px 0;
      word-break: break-all;
    }
    #soundToggle {
      position: fixed;
      top: 10px;
      left: 10px;
      background: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 100;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      .container {
        padding: 15px;
        margin: 10px;
      }
      #wordDisplay {
        font-size: 30px;
        letter-spacing: 5px;
      }
      #keyboard button {
        min-width: 30px;
        font-size: 16px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- כפתור שליטה בצליל -->
  <div id="soundToggle" onclick="toggleSound()">🔊</div>

  <!-- צלילים -->
  <audio id="correctSound" src="https://www.soundjay.com/buttons/button-09a.mp3" preload="auto"></audio>
  <audio id="wrongSound" src="https://www.soundjay.com/buttons/button-10.mp3" preload="auto"></audio>
  <audio id="winSound" src="https://www.soundjay.com/human/human-crowd-cheer-01.mp3" preload="auto"></audio>
  <audio id="loseSound" src="https://www.soundjay.com/human/human-groan-01.mp3" preload="auto"></audio>
  <audio id="tickSound" src="https://www.soundjay.com/mechanical/mechanical-clock-ticking-1.mp3" preload="auto"></audio>

  <!-- טופס התחברות/הרשמה -->
  <div id="authContainer" class="container">
    <h1>ברוכים הבאים לאיש תלוי אונליין</h1>
    <p>התחבר או הירשם כדי להתחיל לשחק</p>
    <input type="email" id="email" placeholder="מייל">
    <input type="password" id="password" placeholder="סיסמה">
    <input type="text" id="nickname" placeholder="כינוי">
    <button class="btn-primary" onclick="signUp()">הירשם</button>
    <button class="btn-success" onclick="signIn()">התחבר</button>
    <p id="status"></p>
  </div>

  <!-- דף הבית -->
  <div id="homeContainer" class="container hidden">
    <h1 id="welcomeMessage">ברוכים הבאים!</h1>
    <button class="btn-danger" onclick="signOut()">התנתק</button>
    
    <h2>טבלת מובילים</h2>
    <table id="leaderboard">
      <tr><th>כינוי</th><th>ניקוד</th><th>משחקים</th><th>זמן ממוצע</th></tr>
    </table>
    
    <!-- טופס הצטרפות באמצעות קוד -->
    <div>
      <h3>הצטרף למשחק עם קוד</h3>
      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <input type="text" id="joinGameCode" placeholder="הכנס קוד משחק" style="flex:1;">
        <button class="btn-primary" onclick="joinGameWithCode()">הצטרף</button>
      </div>
    </div>
    
    <h2>חדרי המתנה</h2>
    <div id="lobbies"></div>
    
    <div>
      <button class="btn-success" onclick="createLobby()">צור משחק חדש</button>
      <button class="btn-primary" onclick="showInviteForm()">הזמן שחקן עם קוד</button>
    </div>
    
    <!-- טופס הזמנת שחקן -->
    <div id="inviteForm" class="hidden">
      <h3>הזמנת שחקן</h3>
      <input type="text" id="gameWord" placeholder="הכנס מילה למשחק">
      <button class="btn-success" onclick="createDirectInvite()">צור קוד הזמנה</button>
      <div id="inviteLink" class="invite-link hidden"></div>
    </div>
  </div>

  <!-- מסך המשחק -->
  <div id="gameContainer" class="container hidden">
    <h1>איש תלוי - משחק</h1>
    <p id="gameStatus"></p>
    
    <div class="round-info">
      <div>
        <span id="mistakesCount">טעויות: 0/10</span>
      </div>
      <div id="timerDisplay">זמן: 00:00</div>
      <div>
        <span id="scoreDisplay">ניקוד: 0</span>
      </div>
    </div>
    
    <div id="wordDisplay"></div>
    <canvas id="hangmanCanvas" width="200" height="200"></canvas>
    <div id="keyboard"></div>
    <div id="chat"></div>
    <div style="display: flex; gap: 10px;">
      <input type="text" id="chatInput" placeholder="כתוב הודעה" style="flex: 1;">
      <button class="btn-primary" onclick="sendChat()">שלח</button>
    </div>
    <button class="btn-danger" onclick="exitGame()">חזור לדף הבית</button>
  </div>

  <script>
    console.log("סקריפט נטען");

    const firebaseConfig = {
      apiKey: "AIzaSyBiKGygJc5u4tQeebDVCD8_AP1r6kgm4Lc",
      authDomain: "hangmanonline-902ac.firebaseapp.com",
      databaseURL: "https://hangmanonline-902ac-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hangmanonline-902ac",
      storageBucket: "hangmanonline-902ac.firebasestorage.app",
      messagingSenderId: "577708158727",
      appId: "1:577708158727:web:e1aafd176c77df7d801fa2"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const realtimeDb = firebase.database();

    if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
      console.log("מריץ ב-Emulator מקומי");
      auth.useEmulator("http://localhost:9099");
      db.useEmulator("localhost", 8080);
      realtimeDb.useEmulator("localhost", 9000);
    }
    
    // פתרון בעיית התחברות כאשר האתר מפורסם
    if (document.getElementById('firebaseConnectionError')) {
      document.getElementById('firebaseConnectionError').style.display = 'none';
    }
    
    // הוספת אלמנט להתראות חיבור לפיירבייס
    const connectionAlert = document.createElement('div');
    connectionAlert.id = 'firebaseConnectionAlert';
    connectionAlert.style.position = 'fixed';
    connectionAlert.style.bottom = '10px';
    connectionAlert.style.right = '10px';
    connectionAlert.style.padding = '15px';
    connectionAlert.style.background = '#f8d7da';
    connectionAlert.style.color = '#721c24';
    connectionAlert.style.borderRadius = '5px';
    connectionAlert.style.zIndex = '1000';
    connectionAlert.style.display = 'none';
    connectionAlert.style.maxWidth = '350px';
    connectionAlert.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
    connectionAlert.innerHTML = `
      <p style="margin: 0; font-weight:bold; font-size:16px">עדיין אין חיבור לשרת</p>
      <p style="margin: 5px 0">ייתכן שהבעיה היא באחד מהבאים:</p>
      <ol style="margin: 5px 0; padding-right: 20px; text-align: right">
        <li>הגבלת גישה ברשת או בפיירוול שלך</li>
        <li>חסימת DNS של ספק האינטרנט</li>
        <li>הגדרות Firebase לא מעודכנות</li>
      </ol>
      <p style="margin: 5px 0; font-weight:bold">פתרונות אפשריים:</p>
      <ol style="margin: 5px 0; padding-right: 20px; text-align: right">
        <li>שנה את שרתי ה-DNS לשרתים ציבוריים (8.8.8.8 או 1.1.1.1)</li>
        <li>נסה להתחבר דרך רשת אינטרנט אחרת (למשל חיבור סלולרי)</li>
        <li>ודא שהדומיין ${window.location.hostname} מורשה ב-Firebase</li>
      </ol>
      <div style="margin-top:10px">
        <button onclick="retryConnection()" style="background:#0275d8; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer">נסה שוב</button>
        <button onclick="this.parentElement.parentElement.style.display='none'" style="background:#6c757d; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer">סגור</button>
      </div>
    `;
    document.body.appendChild(connectionAlert);

    // משתנים גלובליים
    let currentLobbyId = null;
    let currentUserNickname = null;
    let gameTimer = null;
    let gameStartTime = null;
    let gameTimeTaken = 0;
    let letterTimers = {};
    let currentRoundScore = 0;
    let soundEnabled = true;
    let joinTransactionTimeout = null; // טיימר גלובלי לתהליך הצטרפות

    // בדיקת פרמטרים ב-URL
    function checkUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const inviteId = urlParams.get('invite');
      
      // אם יש קוד הזמנה ב-URL
      if (inviteId) {
        console.log("התקבל קוד הזמנה:", inviteId);
        // כדי למנוע שרשור של הפרמטרים, ננקה את ה-URL
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // שמירת קוד ההזמנה לשימוש אחרי התחברות
        sessionStorage.setItem('pendingInvite', inviteId);
      }
    }
    
    // בדיקת קוד הזמנה בטעינת הדף
    window.addEventListener('load', () => {
      // ניקוי כל משתני המצב בטעינה מחדש
      window.joiningLobby = false;
      if (joinTransactionTimeout) {
        clearTimeout(joinTransactionTimeout);
        joinTransactionTimeout = null;
      }
      
      checkUrlParams();
    });
    
    // פונקציה לבדיקת הזמנות ממתינות לאחר התחברות
    function checkPendingInvites() {
      const pendingInvite = sessionStorage.getItem('pendingInvite');
      if (pendingInvite) {
        console.log("מממש הזמנה ממתינה:", pendingInvite);
        sessionStorage.removeItem('pendingInvite');
        
        // בדיקה שההזמנה עדיין קיימת ותקפה
        realtimeDb.ref('invites/' + pendingInvite).once('value')
          .then((snapshot) => {
            if (snapshot.exists()) {
              const invite = snapshot.val();
              // בדיקת תוקף ההזמנה (24 שעות)
              if (Date.now() - invite.created < 24 * 60 * 60 * 1000) {
                return joinInvitedLobby(invite.lobbyId);
              } else {
                alert("הזמנה זו פגה תוקף");
              }
            } else {
              alert("ההזמנה לא נמצאה או שהיא כבר מומשה");
            }
          })
          .catch((error) => {
            console.error("שגיאה בבדיקת הזמנה:", error);
          });
      }
    }

    // פונקציה להשתקת/הפעלת צלילים
    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById('soundToggle').innerHTML = soundEnabled ? '🔊' : '🔇';
    }
    
    // פונקציה לניסיון חיבור מחדש לשרת
    function retryConnection() {
      console.log("מנסה להתחבר מחדש לשרת Firebase...");
      document.getElementById('lobbies').innerHTML = '<div class="loader"></div><p>מנסה להתחבר מחדש...</p>';
      
      // ניסיון לאתחל מחדש את חיבור Firebase
      try {
        // רענון טוקן אימות
        if (auth.currentUser) {
          auth.currentUser.getIdToken(true)
            .then(() => console.log("טוקן אימות רוענן בהצלחה"))
            .catch(e => console.error("שגיאה ברענון טוקן:", e));
        }
      } catch (e) {
        console.error("שגיאה בניסיון רענון חיבור:", e);
      }
      
      // בדיקת חיבור חדשה
      realtimeDb.ref('.info/connected').once('value')
        .then((snapshot) => {
          if (snapshot.val() === true) {
            console.log("החיבור הצליח!");
            
            // הסתר את ההתראה
            if (document.getElementById('firebaseConnectionAlert')) {
              document.getElementById('firebaseConnectionAlert').style.display = 'none';
            }
            
            loadLobbies();
          } else {
            console.error("עדיין אין חיבור לשרת");
            
            // הצג מידע מפורט על בעיית החיבור
            document.getElementById('lobbies').innerHTML = 
              '<div style="background:#f8d7da; padding:15px; border-radius:8px; margin:10px 0; text-align:right">' +
              '<p style="font-weight:bold; font-size:18px">אין חיבור לשרת</p>' +
              '<p>ייתכן וזו בעיה באחת מהאפשרויות הבאות:</p>' +
              '<ol>' +
              '<li><strong>סינון אינטרנט:</strong> ייתכן שחיבור האינטרנט שלך חוסם גישה לשירותי Firebase</li>' +
              '<li><strong>הגבלת DNS:</strong> ספק האינטרנט שלך עשוי לחסום את הדומיינים של Firebase</li>' +
              '<li><strong>הגדרות Firebase:</strong> אולי צריך להוסיף את הדומיין הנוכחי להגדרות</li>' +
              '</ol>' +
              '<p><strong>הצעות לפתרון:</strong></p>' +
              '<ol>' +
              '<li>שנה את שרתי ה-DNS לשרתים ציבוריים (Google: 8.8.8.8 או Cloudflare: 1.1.1.1)</li>' +
              '<li>נסה להשתמש ברשת אינטרנט אחרת (למשל חיבור סלולרי)</li>' +
              '<li>אם אתה מנהל האתר, הוסף את הדומיין <code>' + window.location.hostname + '</code> להגדרות Firebase</li>' +
              '</ol>' +
              '<p><button onclick="retryConnection()" class="btn-primary">נסה להתחבר שוב</button></p>' +
              '</div>';
          }
        })
        .catch(error => {
          console.error("שגיאה בבדיקת חיבור:", error);
          document.getElementById('lobbies').innerHTML = 
            '<p>שגיאת התחברות: ' + error.message + '</p>' +
            '<button onclick="retryConnection()" class="btn-primary">נסה שוב</button>' +
            '<p>נסה לרענן את הדף או לבדוק את חיבור האינטרנט שלך</p>';
        });
    }
    
    // פונקציה משופרת להשמעת צליל שבודקת שהצליל פעיל
    function playSound(soundId) {
      if (!soundEnabled) return;
      
      const sound = document.getElementById(soundId);
      if (sound) {
        // איפוס הצליל לפני הפעלה מחדש
        sound.pause();
        sound.currentTime = 0;
        sound.play().catch(e => console.error("שגיאה בהשמעת צליל:", e));
      }
    }
    
    // פונקציית ריענון אוטומטי כל דקה
    function setupAutoRefresh() {
      setInterval(() => {
        if (auth.currentUser && currentUserNickname) {
          console.log("מבצע ריענון נתונים אוטומטי");
          loadLobbies();
        }
      }, 60000); // כל דקה
    }
    
    // מטפל באירועי ניתוק
    function setupConnectionMonitoring() {
      realtimeDb.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
          console.log("מחובר לשרת Firebase");
          
          // כאשר מתחברים מחדש - מעדכנים את המשתמשים המקוונים
          if (auth.currentUser && currentUserNickname) {
            realtimeDb.ref('online_users/' + auth.currentUser.uid).set({
              nickname: currentUserNickname,
              last_active: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              console.log("עדכון סטטוס מקוון בהצלחה");
              // מרענן את רשימת החדרים אחרי חיבור מחדש
              loadLobbies();
            });
          }
        } else {
          console.log("מנותק משרת Firebase");
        }
      });
    }
    
    auth.onAuthStateChanged((user) => {
      if (user) {
        console.log("משתמש מחובר:", user.uid);
        document.getElementById('authContainer').classList.add('hidden');
        document.getElementById('homeContainer').classList.remove('hidden');
        document.getElementById('gameContainer').classList.add('hidden');
        loadUserData(user);
        
        // הגדרת ריענון אוטומטי וניטור חיבור
        setupAutoRefresh();
        setupConnectionMonitoring();
        
        // האזנה לעדכונים גלובליים
        setupGlobalUpdatesListener();
        
        // בדיקת הזמנות ממתינות
        checkPendingInvites();
      } else {
        console.log("משתמש לא מחובר");
        document.getElementById('authContainer').classList.remove('hidden');
        document.getElementById('homeContainer').classList.add('hidden');
        document.getElementById('gameContainer').classList.add('hidden');
        currentUserNickname = null;
        currentLobbyId = null;
        
        // ניקוי טיימרים וניתוק האזנות
        stopGameTimers();
        
        // מוריד את ההאזנה למסד הנתונים
        realtimeDb.ref('lobbies').off();
        realtimeDb.ref('.info/connected').off();
        realtimeDb.ref('global_updates').off();
      }
    });
    
    // ניהול טיימרים
    function startGameTimer() {
      stopGameTimers(); // ניקוי טיימרים קודמים
      
      gameStartTime = Date.now();
      gameTimeTaken = 0;
      
      gameTimer = setInterval(() => {
        const elapsedSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        
        document.getElementById('timerDisplay').textContent = 
          `זמן: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // בדיקה אם לנגן צליל "טיק טק" כשנשארו פחות מ-10 שניות
        if (minutes === 0 && seconds >= 50 && seconds <= 59) {
          if (soundEnabled && seconds % 2 === 0) {
            playSound('tickSound');
          }
        }
      }, 1000);
    }
    
    function startLetterTimer(letter) {
      // מעקב אחר זמן כל אות
      letterTimers[letter] = {
        startTime: Date.now()
      };
    }
    
    function stopLetterTimer(letter) {
      if (letterTimers[letter]) {
        letterTimers[letter].endTime = Date.now();
        letterTimers[letter].timeTaken = 
          (letterTimers[letter].endTime - letterTimers[letter].startTime) / 1000;
      }
    }
    
    function stopGameTimers() {
      if (gameTimer) {
        clearInterval(gameTimer);
        gameTimer = null;
      }
      
      if (gameStartTime) {
        gameTimeTaken = (Date.now() - gameStartTime) / 1000;
      }
      
      // איפוס טיימרים של אותיות
      letterTimers = {};
    }
    
    // פונקציה להצגת טופס יצירת הזמנה ישירה
    function showInviteForm() {
      const inviteForm = document.getElementById('inviteForm');
      if (inviteForm.classList.contains('hidden')) {
        inviteForm.classList.remove('hidden');
      } else {
        inviteForm.classList.add('hidden');
        document.getElementById('inviteLink').classList.add('hidden');
      }
    }
    
    // פונקציה ליצירת הזמנה ישירה
    function createDirectInvite() {
      const word = document.getElementById('gameWord').value.trim();
      if (!word || !/^[א-תךםןףץ ]+$/.test(word)) {
        return alert("יש להזין מילה תקינה (אותיות בעברית ורווחים בלבד)");
      }
      
      // יצירת לובי חדש
      realtimeDb.ref('lobbies').push({
        creator: currentUserNickname,
        status: 'waiting',
        players: [currentUserNickname],
        word: word.toLowerCase(),
        guesses: [],
        mistakes: 0,
        chat: [],
        isPrivate: true, // לובי פרטי שלא יופיע ברשימה הכללית
        createdAt: firebase.database.ServerValue.TIMESTAMP
      }).then((result) => {
        const lobbyId = result.key;
        
        // יצירת קוד הזמנה
        const inviteId = generateInviteCode();
        
        // שמירת ההזמנה
        return realtimeDb.ref('invites/' + inviteId).set({
          lobbyId: lobbyId,
          creator: currentUserNickname,
          created: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          // בניית קישור הזמנה
          const inviteLink = `${window.location.origin}${window.location.pathname}?invite=${inviteId}`;
          
          // הצגת הקישור למשתמש
          const inviteLinkElement = document.getElementById('inviteLink');
          inviteLinkElement.textContent = inviteLink;
          inviteLinkElement.classList.remove('hidden');
          
          return inviteLink;
        });
      }).catch((error) => {
        console.error("שגיאה ביצירת הזמנה ישירה:", error);
        alert("שגיאה ביצירת הזמנה: " + error.message);
      });
    }
    
    // פונקציה ליצירת קוד הזמנה אקראי
    function generateInviteCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }
    
    // פונקציה להצטרפות למשחק עם קוד
    function joinGameWithCode() {
      const gameCode = document.getElementById('joinGameCode').value.trim().toUpperCase();
      
      if (!gameCode) {
        return alert("יש להזין קוד משחק");
      }
      
      console.log("מנסה להצטרף למשחק עם קוד:", gameCode);
      
      // בדיקת חיבור לפני ניסיון הצטרפות
      realtimeDb.ref('.info/connected').once('value')
        .then((snapshot) => {
          if (snapshot.val() !== true) {
            throw new Error("אין חיבור לשרת. נא לרענן את הדף ולנסות שוב");
          }
          
          // חיפוש מזהה חדר על פי קוד משחק
          return realtimeDb.ref('game_codes/' + gameCode).once('value');
        })
        .then((snapshot) => {
          if (!snapshot.exists()) {
            throw new Error("קוד משחק לא קיים");
          }
          
          const gameData = snapshot.val();
          const lobbyId = gameData.lobbyId;
          
          if (!lobbyId) {
            throw new Error("נתוני משחק חסרים");
          }
          
          console.log("נמצא חדר עם הקוד:", lobbyId);
          
          // בדיקה שהחדר עדיין קיים
          return realtimeDb.ref('lobbies/' + lobbyId).once('value')
            .then(lobbySnapshot => {
              if (!lobbySnapshot.exists()) {
                throw new Error("חדר המשחק לא נמצא");
              }
              
              // תחילת תהליך הצטרפות
              return joinLobby(lobbyId, true);
            });
        })
        .catch((error) => {
          console.error("שגיאה בהצטרפות עם קוד:", error);
          alert("שגיאה בהצטרפות: " + error.message);
        });
    }
    
    // פונקציה להצטרפות ללובי דרך הזמנה
    function joinInvitedLobby(lobbyId) {
      console.log("מנסה להצטרף ללובי דרך הזמנה:", lobbyId);
      
      if (!lobbyId) {
        console.error("מזהה חדר לא תקין");
        alert("קישור הזמנה לא תקין");
        return;
      }
      
      // בדיקה שהלובי קיים
      realtimeDb.ref('lobbies/' + lobbyId).once('value')
        .then((snapshot) => {
          if (!snapshot.exists()) {
            throw new Error("חדר המשחק לא נמצא");
          }
          
          const lobby = snapshot.val();
          
          // בדיקה שהלובי במצב המתנה
          if (lobby.status !== 'waiting') {
            throw new Error("חדר המשחק כבר מלא");
          }
          
          // בדיקה שאתה לא יוצר הלובי
          if (lobby.creator === currentUserNickname) {
            throw new Error("אתה כבר יוצר חדר זה");
          }
          
          // התחלת תהליך ההצטרפות
          console.log("מתחיל תהליך הצטרפות לחדר מהזמנה");
          return joinLobby(lobbyId, true);
        })
        .catch((error) => {
          console.error("שגיאה בהצטרפות ללובי דרך הזמנה:", error);
          alert("שגיאה בהצטרפות לחדר: " + error.message);
        });
    }
    
    // פונקציה משופרת ליצירת הזמנה ישירה עם קוד
    function createDirectInvite() {
      const word = document.getElementById('gameWord').value.trim();
      if (!word || !/^[א-תךםןףץ ]+$/.test(word)) {
        return alert("יש להזין מילה תקינה (אותיות בעברית ורווחים בלבד)");
      }
      
      // יצירת קוד משחק ייחודי
      const gameCode = generateInviteCode();
      
      // יצירת לובי חדש
      realtimeDb.ref('lobbies').push({
        creator: currentUserNickname,
        status: 'waiting',
        players: [currentUserNickname],
        word: word.toLowerCase(),
        guesses: [],
        mistakes: 0,
        chat: [],
        gameCode: gameCode, // קוד המשחק
        isPrivate: true, // לובי פרטי שלא יופיע ברשימה הכללית
        createdAt: firebase.database.ServerValue.TIMESTAMP
      }).then((result) => {
        const lobbyId = result.key;
        
        // שמירת קישור הלובי למציאה מהירה לפי קוד
        return realtimeDb.ref('game_codes/' + gameCode).set({
          lobbyId: lobbyId,
          creator: currentUserNickname,
          created: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          // הצגת הקוד למשתמש
          const inviteLinkElement = document.getElementById('inviteLink');
          inviteLinkElement.textContent = `קוד הזמנה: ${gameCode}`;
          inviteLinkElement.classList.remove('hidden');
          
          alert(`המשחק נוצר! קוד הזמנה: ${gameCode}`);
          
          return gameCode;
        });
      }).catch((error) => {
        console.error("שגיאה ביצירת הזמנה ישירה:", error);
        alert("שגיאה ביצירת הזמנה: " + error.message);
      });
    }
    
    // פונקציה חדשה להאזנה לעדכונים גלובליים
    function setupGlobalUpdatesListener() {
      // האזנה לשינויים ברשימת החדרים
      realtimeDb.ref('global_updates/lobbies').on('value', (snapshot) => {
        if (snapshot.exists() && auth.currentUser) {
          console.log("התקבל עדכון גלובלי לרשימת חדרים");
          loadLobbies();
        }
      }, (error) => console.error("שגיאה בהאזנה לעדכונים גלובליים:", error));
    }

    function signUp() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const nickname = document.getElementById('nickname').value;
      
      if (!email || !password) {
        return document.getElementById('status').textContent = "יש למלא מייל וסיסמה";
      }
      
      if (!nickname) {
        return document.getElementById('status').textContent = "אנא בחר כינוי";
      }
      
      document.getElementById('status').textContent = "מתחבר...";
      
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          return db.collection('users').doc(userCredential.user.uid).set({ 
            nickname, 
            score: 0,
            games_played: 0,
            avg_time: 0,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });
        })
        .then(() => {
          document.getElementById('status').textContent = "נרשמת בהצלחה!";
        })
        .catch((error) => {
          document.getElementById('status').textContent = "שגיאה: " + error.message;
        });
    }

    function signIn() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        return document.getElementById('status').textContent = "יש למלא מייל וסיסמה";
      }
      
      document.getElementById('status').textContent = "מתחבר...";
      
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById('status').textContent = "התחברת בהצלחה!";
        })
        .catch((error) => {
          document.getElementById('status').textContent = "שגיאה: " + error.message;
        });
    }

    function signOut() {
      auth.signOut().then(() => {
        console.log("התנתקות בוצעה בהצלחה");
      }).catch((error) => {
        console.error("שגיאה בהתנתקות:", error);
      });
    }

    function loadUserData(user) {
      db.collection('users').doc(user.uid).get()
        .then((doc) => {
          if (doc.exists) {
            currentUserNickname = doc.data().nickname;
            document.getElementById('welcomeMessage').textContent = `ברוכים הבאים ${currentUserNickname}!`;
            loadLeaderboard();
            loadLobbies();
          } else {
            console.error("משתמש קיים אך אין נתונים בפיירסטור");
            // ניצור רישום למשתמש אם הוא לא קיים
            if (user.email) {
              db.collection('users').doc(user.uid).set({
                nickname: user.email.split('@')[0],
                score: 0,
                games_played: 0,
                avg_time: 0,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              }).then(() => {
                loadUserData(user); // טען שוב אחרי יצירת הנתונים
              });
            }
          }
        })
        .catch((error) => {
          console.error("שגיאה בטעינת משתמש:", error);
        });
    }

    function loadLeaderboard() {
      const leaderboard = document.getElementById('leaderboard');
      leaderboard.innerHTML = '<tr><th>כינוי</th><th>ניקוד</th><th>משחקים</th><th>זמן ממוצע</th></tr>';
      
      // הוספת אינדיקטור טעינה
      leaderboard.innerHTML += '<tr><td colspan="4"><div class="loader"></div></td></tr>';
      
      db.collection('users').orderBy('score', 'desc').limit(5).get()
        .then((querySnapshot) => {
          // הסרת אינדיקטור הטעינה
          leaderboard.innerHTML = '<tr><th>כינוי</th><th>ניקוד</th><th>משחקים</th><th>זמן ממוצע</th></tr>';
          
          if (!querySnapshot.empty) {
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const avgTime = data.avg_time ? data.avg_time.toFixed(1) + 's' : '-';
              leaderboard.innerHTML += `
                <tr>
                  <td>${data.nickname || '-'}</td>
                  <td>${data.score || 0}</td>
                  <td>${data.games_played || 0}</td>
                  <td>${avgTime}</td>
                </tr>`;
            });
          } else {
            leaderboard.innerHTML += '<tr><td colspan="4">אין נתונים עדיין</td></tr>';
          }
        })
        .catch((error) => {
          console.error("שגיאה בטעינת טבלת מובילים:", error);
          leaderboard.innerHTML = '<tr><th>כינוי</th><th>ניקוד</th><th>משחקים</th><th>זמן ממוצע</th></tr>';
          leaderboard.innerHTML += '<tr><td colspan="4">שגיאה בטעינת נתונים</td></tr>';
        });
    }

    function loadLobbies() {
      const lobbiesDiv = document.getElementById('lobbies');
      lobbiesDiv.innerHTML = '<div class="loader"></div>';
      
      // ודא שהמשתמש מחובר
      if (!currentUserNickname || !auth.currentUser) {
        console.log("אין משתמש מחובר, לא טוען חדרים");
        lobbiesDiv.innerHTML = '<p>יש להתחבר כדי לראות חדרים</p>';
        return;
      }
      
      console.log("טוען חדרים עבור המשתמש:", currentUserNickname);
      
      // קודם נבדוק את מצב החיבור לשרת
      realtimeDb.ref('.info/connected').once('value')
        .then((connectedSnapshot) => {
          if (connectedSnapshot.val() !== true) {
            console.error("אין חיבור לשרת Firebase");
            
            // הצג התראה בדבר אישור דומיין
            if (document.getElementById('firebaseConnectionAlert')) {
              document.getElementById('firebaseConnectionAlert').style.display = 'block';
              
              // הסתר אחרי 30 שניות
              setTimeout(() => {
                document.getElementById('firebaseConnectionAlert').style.display = 'none';
              }, 30000);
            }
            
            lobbiesDiv.innerHTML = 
              '<p>אין חיבור לשרת. <button onclick="retryConnection()" class="btn-primary">נסה להתחבר שוב</button></p>' +
              '<div id="firebaseConnectionError">' +
              '<p>שים לב: אם אתה משתמש בגרסה המפורסמת של האתר, יש להוסיף את הדומיין הנוכחי להגדרות Firebase:</p>' +
              '<code>' + window.location.hostname + '</code>' +
              '<p>יש להיכנס לקונסולת Firebase > Authentication > Domains ולהוסיף את הכתובת הזו</p>' +
              '</div>';
            
            // נסיון נוסף אוטומטי לאחר 5 שניות
            setTimeout(() => retryConnection(), 5000);
            return;
          }
        
        console.log("חיבור לשרת Firebase פעיל");
        
        // עדכון סטטוס מקוון
        realtimeDb.ref('online_users/' + auth.currentUser.uid).set({
          nickname: currentUserNickname,
          last_active: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          console.log("סטטוס מקוון עודכן בהצלחה");
        }).catch(error => {
          console.error("שגיאה בעדכון סטטוס מקוון:", error);
        });
        
        // עדכון רשימת חדרים גלובלית
        realtimeDb.ref('lobbies_list').update({
          lastUpdate: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          console.log("רשימת חדרים גלובלית עודכנה");
        }).catch(error => {
          console.error("שגיאה בעדכון רשימת חדרים גלובלית:", error);
        });
        
        // הסרת האזנות קודמות
        realtimeDb.ref('lobbies').off();
        
        // האזנה לרשימת החדרים
        realtimeDb.ref('lobbies').on('value', (snapshot) => {
          lobbiesDiv.innerHTML = '';
          
          if (!snapshot.exists()) {
            console.log("אין חדרים פתוחים בדאטאבייס");
            lobbiesDiv.innerHTML = '<p>אין חדרים פתוחים כרגע</p>';
            return;
          }
          
          let openLobbies = [];
          let userLobbies = [];
          let activeGames = [];
          
          snapshot.forEach((childSnapshot) => {
            try {
              const lobby = childSnapshot.val();
              const lobbyId = childSnapshot.key;
              
              // בדיקות תקינות מקיפות
              if (!lobby || typeof lobby !== 'object') {
                console.log("נמצא חדר לא תקין:", lobbyId);
                return;
              }
              
              // וודא שכל השדות הנדרשים קיימים
              if (!lobby.creator || !lobby.status) {
                console.log("חדר חסר נתונים בסיסיים:", lobbyId);
                
                // נסה לנקות חדרים לא תקינים
                realtimeDb.ref('lobbies/' + lobbyId).remove()
                  .then(() => console.log("חדר לא תקין נמחק:", lobbyId))
                  .catch(e => console.error("שגיאה במחיקת חדר לא תקין:", e));
                return;
              }
              
              // דילוג על חדרים פרטיים של משתמשים אחרים
              if (lobby.isPrivate && lobby.creator !== currentUserNickname) {
                return;
              }
              
              // וודא שמערך השחקנים תקין
              let players = [];
              if (lobby.players && Array.isArray(lobby.players)) {
                players = lobby.players;
              } else if (lobby.creator) {
                players = [lobby.creator];
              }
              
              // בדוק אם המשתמש הנוכחי יצר או משתתף בחדר
              const isParticipant = players.includes(currentUserNickname);
              const isCreator = lobby.creator === currentUserNickname;
              
              // חדר בהמתנה שהמשתמש לא יצר
              if (lobby.status === 'waiting' && !isCreator && !lobby.isPrivate) {
                openLobbies.push({ lobbyId, creator: lobby.creator, timestamp: lobby.createdAt });
              } 
              // חדר פעיל שהמשתמש משתתף בו
              else if (lobby.status === 'full' && isParticipant) {
                activeGames.push({ lobbyId, isCreator });
              } 
              // חדר שהמשתמש יצר והוא בהמתנה
              else if (isCreator && lobby.status === 'waiting') {
                userLobbies.push({ 
                  lobbyId, 
                  private: lobby.isPrivate, 
                  timestamp: lobby.createdAt 
                });
              } 
            } catch (error) {
              console.error("שגיאה בעיבוד חדר:", error);
            }
          });
          
          console.log(`נמצאו ${openLobbies.length} חדרים פתוחים, ${userLobbies.length} חדרים של המשתמש, ${activeGames.length} משחקים פעילים`);
          
          // מיון חדרים לפי זמן יצירה
          openLobbies.sort((a, b) => b.timestamp - a.timestamp);
          userLobbies.sort((a, b) => b.timestamp - a.timestamp);
          
          // הצגת חדרים פתוחים
          if (openLobbies.length > 0) {
            lobbiesDiv.innerHTML += '<h3>חדרים פתוחים להצטרפות</h3>';
            openLobbies.forEach(lobby => {
              const lobbyTime = new Date(lobby.timestamp || Date.now()).toLocaleTimeString();
              lobbiesDiv.innerHTML += `
                <div class="lobby-card">
                  <p>${lobby.creator} ממתין לשחקן - נוצר ב-${lobbyTime}</p>
                  <button class="btn-primary" onclick="joinLobby('${lobby.lobbyId}')">הצטרף</button>
                </div>`;
            });
          } else {
            lobbiesDiv.innerHTML += '<p>אין חדרים פתוחים כרגע להצטרפות</p>';
          }
          
          // הצג חדרים של המשתמש
          if (userLobbies.length > 0) {
            lobbiesDiv.innerHTML += `<h3>החדרים שלך</h3>`;
            userLobbies.forEach(lobby => {
              const lobbyTime = new Date(lobby.timestamp || Date.now()).toLocaleTimeString();
              const privacyText = lobby.private ? 'פרטי' : 'ציבורי';
              lobbiesDiv.innerHTML += `
                <div class="lobby-card">
                  <p>יצרת חדר ${privacyText} ב-${lobbyTime}</p>
                  <button class="btn-danger" onclick="cancelLobby('${lobby.lobbyId}')">בטל חדר</button>
                </div>`;
            });
          }
          
          // התחל משחקים פעילים
          if (activeGames.length > 0) {
            console.log(`המשתמש ${currentUserNickname} משתתף במשחק ${activeGames[0].lobbyId} שמתחיל עכשיו`);
            
            // ניקוי טיימרים לפני התחלת משחק חדש
            stopGameTimers();
            
            // איפוס תצוגת הטיימר
            document.getElementById('timerDisplay').textContent = 'זמן: 00:00';
            
            // התחלת המשחק
            startGame(activeGames[0].lobbyId);
          }
        }, (error) => {
          console.error("שגיאה בטעינת חדרים:", error);
          lobbiesDiv.innerHTML = '<p>שגיאה בטעינת חדרים. נסה לרענן את הדף</p>';
        });
      });
    }
    
    // פונקציה לביטול חדר
    function cancelLobby(lobbyId) {
      realtimeDb.ref('lobbies/' + lobbyId).remove()
        .then(() => {
          console.log("חדר נמחק בהצלחה");
          
          // מחק הזמנות הקשורות לחדר זה
          realtimeDb.ref('invites').orderByChild('lobbyId').equalTo(lobbyId).once('value', snapshot => {
            if (snapshot.exists()) {
              const updates = {};
              snapshot.forEach(child => {
                updates[child.key] = null;
              });
              realtimeDb.ref('invites').update(updates);
            }
          });
          
          // עדכון רשימת חדרים גלובלית
          realtimeDb.ref('global_updates/lobbies').set(Date.now());
        })
        .catch((error) => {
          console.error("שגיאה במחיקת חדר:", error);
          alert("שגיאה במחיקת חדר: " + error.message);
        });
    }

    function createLobby() {
      if (!currentUserNickname) return alert("כינוי לא נטען עדיין");
      const word = prompt("בחר מילה או ביטוי למשחק (רק אותיות עבריות ורווחים):");
      if (!word || !/^[א-תךםןףץ ]+$/.test(word)) return alert("מילה לא תקינה");
      
      // בדיקה שהמשתמש אינו יוצר יותר מדי חדרים
      realtimeDb.ref('lobbies').once('value')
        .then((snapshot) => {
          let userRoomCount = 0;
          if (snapshot.exists()) {
            snapshot.forEach((child) => {
              const room = child.val();
              if (room && room.creator === currentUserNickname) {
                userRoomCount++;
              }
            });
          }
          
          if (userRoomCount >= 3) {
            return alert("יש לך כבר " + userRoomCount + " חדרים פתוחים. מחק את החדרים הישנים לפני יצירת חדש.");
          }
          
          // בדיקת חיבור לשרת
          return realtimeDb.ref('.info/connected').once('value');
        })
        .then((snapshot) => {
          if (!snapshot || snapshot.val() !== true) {
            throw new Error("אין חיבור לשרת");
          }
          
          console.log("מחובר לשרת - ממשיך ביצירת חדר");
          
          // יצירת מזהה חדר חדש
          const lobbyRef = realtimeDb.ref('lobbies').push();
          const lobbyId = lobbyRef.key;
          
          if (!lobbyId) {
            throw new Error("שגיאה: לא ניתן ליצור מזהה חדר");
          }
          
          // יצירת אובייקט החדר
          const newLobby = {
            creator: currentUserNickname,
            status: 'waiting',
            players: [currentUserNickname],
            word: word.toLowerCase(),
            guesses: [],
            mistakes: 0,
            chat: [],
            lastUpdate: firebase.database.ServerValue.TIMESTAMP,
            createdAt: firebase.database.ServerValue.TIMESTAMP
          };
          
          // עדכון החדר בדאטאבייס
          return lobbyRef.set(newLobby);
        })
        .then(() => {
          // עדכון רשימת חדרים גלובלית
          realtimeDb.ref('lobbies_list').set({
            lastUpdate: firebase.database.ServerValue.TIMESTAMP,
            updateCount: firebase.database.ServerValue.increment(1)
          });
          
          // גורם לכל המשתמשים לרענן את רשימת החדרים
          realtimeDb.ref('global_updates/lobbies').set(Date.now());
          
          alert('חדר נוצר! ממתין לשחקן שני...');
          console.log("חדר נוצר בהצלחה");
          
          // טען מחדש את רשימת החדרים למשתמש הנוכחי
          loadLobbies();
        })
        .catch((error) => {
          console.error("שגיאה ביצירת חדר:", error);
          alert("שגיאה ביצירת חדר: " + error.message);
        });
    }

    function joinLobby(lobbyId, isFromInvite = false) {
      if (!currentUserNickname) return alert("כינוי לא נטען עדיין");
      
      console.log(`מנסה להצטרף לחדר ${lobbyId}`);
      
      // למנוע לחיצות כפולות - הוסף דגל "מצטרף"
      if (window.joiningLobby) {
        console.log("כבר מתבצע תהליך הצטרפות לחדר");
        return;
      }
      
      window.joiningLobby = true;
      
      // הצג הודעת טעינה
      document.getElementById('lobbies').innerHTML = '<div class="loader"></div><p>מצטרף לחדר...</p>';
      
      // ניקוי טיימר קודם וקביעת טיימר חדש
      if (joinTransactionTimeout) {
        clearTimeout(joinTransactionTimeout);
        joinTransactionTimeout = null;
      }
      
      // טיימר בטיחות גלובלי שיפעל גם אם נתקע באמצע
      joinTransactionTimeout = setTimeout(() => {
        console.log("טיימר גלובלי - אירעה תקלה בהצטרפות לחדר");
        window.joiningLobby = false;
        currentLobbyId = null;
        
        // נסה להחזיר את המשתמש למצב התחלתי
        document.getElementById('gameContainer').classList.add('hidden');
        document.getElementById('homeContainer').classList.remove('hidden');
        
        // טען מחדש את הלוביז
        loadLobbies();
      }, 15000); // 15 שניות טיים אאוט
      
      // בדיקת חיבור לשרת תחילה
      realtimeDb.ref('.info/connected').once('value')
        .then((connSnapshot) => {
          if (!connSnapshot || connSnapshot.val() !== true) {
            throw new Error("אין חיבור לשרת");
          }
          
          // בדיקה שהחדר קיים לפני ההצטרפות
          return realtimeDb.ref('lobbies/' + lobbyId).once('value');
        })
        .then((snapshot) => {
          if (!snapshot.exists()) {
            console.log("החדר לא נמצא");
            alert("החדר לא נמצא יותר");
            throw new Error("החדר לא נמצא");
          }
          
          const lobby = snapshot.val();
          
          if (lobby.status !== 'waiting') {
            console.log("החדר אינו במצב המתנה");
            alert("החדר כבר מלא או לא בהמתנה");
            throw new Error("החדר אינו במצב המתנה");
          }
          
          // וודא שאתה לא יוצר החדר
          if (lobby.creator === currentUserNickname) {
            console.log("אתה יוצר החדר, לא ניתן להצטרף");
            alert("זהו החדר שלך, אתה כבר בתוכו");
            throw new Error("אתה יוצר החדר");
          }
          
          // התחלת עדכון החדר
          console.log("מתחיל תהליך הצטרפות לחדר");
          
          // עדכן סטטוס חדר להראות שמשתמש נוסף מנסה להצטרף
          return realtimeDb.ref('lobbies/' + lobbyId).update({
            joining_attempt: {
              user: currentUserNickname,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            }
          });
        })
        .then(() => {
          // בדיקה נוספת שהחדר קיים ותקין
          return realtimeDb.ref('lobbies/' + lobbyId).once('value');
        })
        .then(snapshot => {
          if (!snapshot.exists()) {
            throw new Error("החדר לא נמצא יותר");
          }
          
          const currentLobby = snapshot.val();
          
          if (currentLobby.status !== 'waiting') {
            throw new Error("החדר כבר אינו במצב המתנה");
          }
          
          // וודא שהשחקנים מאותחלים נכון
          let players = [];
          if (Array.isArray(currentLobby.players)) {
            players = [...currentLobby.players];
          } else if (currentLobby.creator) {
            players = [currentLobby.creator];
          }
          
          // וודא שהשחקן לא קיים כבר
          if (!players.includes(currentUserNickname)) {
            players.push(currentUserNickname);
          }
          
          // עדכן את הצ'אט
          let chat = [];
          if (Array.isArray(currentLobby.chat)) {
            chat = [...currentLobby.chat];
          } else {
            chat = [];
          }
          
          // הוסף הודעת מערכת
          chat.push({
            nickname: 'מערכת',
            text: `${currentUserNickname} הצטרף למשחק!`,
            timestamp: Date.now()
          });
          
          console.log("מעדכן נתוני חדר ומעדכן סטטוס ל-'full'");
          
          // עדכן את החדר באופן ישיר - זה קריטי להצלחת ההצטרפות
          return realtimeDb.ref('lobbies/' + lobbyId).update({
            status: 'full',
            players: players,
            chat: chat,
            gameStarted: true,
            lastUpdate: firebase.database.ServerValue.TIMESTAMP
          });
        })
        .then(() => {
          console.log("עדכון החדר הצליח, שומר מזהה חדר נוכחי");
          
          // שמירת מזהה החדר הנוכחי חשובה לפני התחלת המשחק
          currentLobbyId = lobbyId;
          
          console.log("הצטרפות לחדר הצליחה!");
          
          // עדכן את רשימת החדרים הגלובלית
          return realtimeDb.ref('global_updates/lobbies').set(Date.now());
        })
        .then(() => {
          console.log("הגדרת תצוגת משחק");
          
          // מעבר למסך המשחק
          document.getElementById('homeContainer').classList.add('hidden');
          document.getElementById('gameContainer').classList.remove('hidden');
          
          // התחל את המשחק - חשוב להפעיל את זה בנפרד אחרי העדכונים הקודמים
          console.log("מתחיל משחק...");
          
          // ניקוי טיימר הבטיחות
          if (joinTransactionTimeout) {
            clearTimeout(joinTransactionTimeout);
            joinTransactionTimeout = null;
          }
          
          // הפרדה בזמן לפני הפעלת startGame - מונע מצב תקוע
          setTimeout(() => {
            console.log("מפעיל startGame עם ID:", lobbyId);
            startGame(lobbyId);
            
            // איפוס דגל ההצטרפות
            window.joiningLobby = false;
          }, 500);
        })
        .catch((error) => {
          // ניקוי טיימר הבטיחות
          if (joinTransactionTimeout) {
            clearTimeout(joinTransactionTimeout);
            joinTransactionTimeout = null;
          }
          
          console.error("שגיאה בהצטרפות למשחק:", error);
          
          // איפוס דגל ההצטרפות
          window.joiningLobby = false;
          currentLobbyId = null;
          
          if (!["החדר לא נמצא", "החדר אינו במצב המתנה", "אתה יוצר החדר", "החדר כבר אינו במצב המתנה"].includes(error.message)) {
            alert("שגיאה בהצטרפות לחדר: " + error.message);
          }
          
          // לאחר שגיאה, רענן את רשימת החדרים
          document.getElementById('gameContainer').classList.add('hidden');
          document.getElementById('homeContainer').classList.remove('hidden');
          loadLobbies();
        });
    }

    function startGame(lobbyId) {
      console.log(`מתחיל משחק בחדר ${lobbyId}`);
      
      if (!lobbyId) {
        console.error("נכשל בהתחלת משחק - חסר מזהה חדר");
        return;
      }
      
      // וודא שאנחנו לא באמצע תהליך התחלת משחק אחר
      if (window.startingGame) {
        console.log("כבר מתבצע תהליך התחלת משחק");
        return;
      }
      
      window.startingGame = true;
      
      // ניקוי טיימרים קודמים - חשוב לכל השחקנים
      stopGameTimers();
      
      // איפוס תצוגת הטיימר לכולם
      document.getElementById('timerDisplay').textContent = 'זמן: 00:00';
      
      // יצירת טיימר בטיחות לתהליך התחלת המשחק
      const startGameTimeout = setTimeout(() => {
        console.log("טיים אאוט בתהליך התחלת משחק");
        window.startingGame = false;
        window.joiningLobby = false;
        
        // חזרה למסך הבית במקרה של תקיעה
        document.getElementById('gameContainer').classList.add('hidden');
        document.getElementById('homeContainer').classList.remove('hidden');
        loadLobbies();
      }, 10000);
      
      // וידוא שהחדר קיים לפני תחילת המשחק
      realtimeDb.ref('lobbies/' + lobbyId).once('value')
        .then((snapshot) => {
          if (!snapshot.exists()) {
            console.error("החדר לא נמצא בתחילת המשחק");
            throw new Error("החדר לא נמצא יותר");
          }
          
          console.log("החדר נמצא, ממשיך בהתחלת המשחק");
          
          // שמירת מזהה החדר הנוכחי
          currentLobbyId = lobbyId;
          
          // מעבר למסך המשחק
          document.getElementById('homeContainer').classList.add('hidden');
          document.getElementById('gameContainer').classList.remove('hidden');
          
          // איפוס הקנבס
          const canvas = document.getElementById('hangmanCanvas');
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          
          // איפוס תצוגת ניקוד
          document.getElementById('scoreDisplay').textContent = 'ניקוד: 0';
          
          // בדיקה אם מדובר בשחקן המצטרף או המארח
          const lobby = snapshot.val();
          const isJoiner = lobby.creator !== currentUserNickname;
          
          console.log("סטטוס: " + (isJoiner ? "שחקן מצטרף" : "שחקן מארח"));
          
          // טעינת מצב המשחק - חשוב לפני התחלת טיימר
          loadGameState(lobbyId);
          
          // התחל טיימר משחק חדש (רק לשחקן המנחש)
          if (isJoiner) {
            console.log("מתחיל טיימר משחק לשחקן המצטרף");
            startGameTimer();
          }
          
          // עדכון מצב המשחק בדאטאבייס
          return realtimeDb.ref('lobbies/' + lobbyId).update({
            gameStarted: true,
            status: 'active', // מסמן שהמשחק פעיל
            lastUpdate: firebase.database.ServerValue.TIMESTAMP
          });
        })
        .then(() => {
          console.log("משחק התחיל בהצלחה");
          
          // ניקוי טיימר הבטיחות
          clearTimeout(startGameTimeout);
          
          // איפוס משתני המצב
          window.startingGame = false;
          window.joiningLobby = false;
        })
        .catch((error) => {
          console.error("שגיאה בתחילת המשחק:", error);
          
          // ניקוי טיימר הבטיחות
          clearTimeout(startGameTimeout);
          
          // איפוס משתנים
          window.startingGame = false;
          window.joiningLobby = false;
          
          if (joinTransactionTimeout) {
            clearTimeout(joinTransactionTimeout);
            joinTransactionTimeout = null;
          }
          
          // ניתוק האזנות במקרה של שגיאה
          realtimeDb.ref('lobbies/' + lobbyId).off();
          
          alert("שגיאה בטעינת המשחק: " + error.message);
          
          // חזרה למסך הבית במקרה של שגיאה
          document.getElementById('gameContainer').classList.add('hidden');
          document.getElementById('homeContainer').classList.remove('hidden');
          
          // רענון רשימת החדרים
          loadLobbies();
        });
    }

    function loadGameState(lobbyId) {
      console.log(`טוען מצב משחק עבור חדר ${lobbyId}`);
      
      if (!lobbyId) {
        console.error("אין מזהה חדר לטעינת מצב משחק");
        return;
      }
      
      const canvas = document.getElementById('hangmanCanvas');
      const ctx = canvas.getContext('2d');
      
      // ניקוי מצב קודם
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById('wordDisplay').textContent = '';
      document.getElementById('gameStatus').textContent = 'טוען משחק...';
      
      // ניתוק האזנות קודמות ויצירת האזנה חדשה
      realtimeDb.ref('lobbies/' + lobbyId).off();
      
      // בדיקה ראשונית אם החדר קיים
      realtimeDb.ref('lobbies/' + lobbyId).once('value')
        .then((snapshot) => {
          if (!snapshot.exists()) {
            console.error("החדר לא קיים בעת טעינת מצב המשחק");
            document.getElementById('gameStatus').textContent = "החדר לא קיים";
            setTimeout(() => exitGame(), 2000);
            return;
          }
          
          console.log("החדר נמצא, מגדיר האזנה למצב המשחק");
          
          // יצירת האזנה מתמשכת למצב המשחק
          realtimeDb.ref('lobbies/' + lobbyId).on('value', (snapshot) => {
            const lobby = snapshot.val();
            if (!lobby) {
              document.getElementById('gameStatus').textContent = "החדר נמחק";
              // חזרה למסך הבית אם החדר לא קיים
              setTimeout(() => {
                exitGame();
              }, 3000);
              return;
            }
        
        // וודא שהמשחק אכן מוגדר כמשחק פעיל
        if (lobby.status !== 'full' && lobby.status !== 'active') {
          console.log("מצב החדר אינו תקין:", lobby.status);
          document.getElementById('gameStatus').textContent = "מצב החדר אינו תקין, חוזר לדף הבית...";
          setTimeout(() => {
            exitGame();
          }, 3000);
          return;
        }

        const word = lobby.word;
        const guesses = Array.isArray(lobby.guesses) ? lobby.guesses : [];
        const mistakes = lobby.mistakes || 0;
        const isCreator = lobby.creator === currentUserNickname;
        
        // עדכון תצוגת טעויות
        document.getElementById('mistakesCount').textContent = `טעויות: ${mistakes}/10`;

        // הצגת המילה
        let display = '';
        for (let char of word) {
          display += guesses.includes(char) ? char + ' ' : (char === ' ' ? '  ' : '_ ');
        }
        document.getElementById('wordDisplay').textContent = display.trim();

        // ציור איש תלוי
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#2c3e50';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        // שיפור ציור האיש התלוי
        if (mistakes >= 1) { ctx.moveTo(50, 180); ctx.lineTo(150, 180); }  // בסיס
        if (mistakes >= 2) { ctx.moveTo(100, 180); ctx.lineTo(100, 20); }  // עמוד אנכי
        if (mistakes >= 3) { ctx.moveTo(100, 20); ctx.lineTo(140, 20); }   // עמוד אופקי
        if (mistakes >= 4) { ctx.moveTo(140, 20); ctx.lineTo(140, 40); }   // חבל
        if (mistakes >= 5) {                                              // ראש
          ctx.moveTo(140, 60);
          ctx.arc(140, 60, 20, 0, Math.PI * 2);
        }
        if (mistakes >= 6) { ctx.moveTo(140, 80); ctx.lineTo(140, 120); } // גוף
        if (mistakes >= 7) { ctx.moveTo(140, 90); ctx.lineTo(120, 110); } // יד שמאל
        if (mistakes >= 8) { ctx.moveTo(140, 90); ctx.lineTo(160, 110); } // יד ימין
        if (mistakes >= 9) { ctx.moveTo(140, 120); ctx.lineTo(120, 150); } // רגל שמאל
        if (mistakes >= 10) { ctx.moveTo(140, 120); ctx.lineTo(160, 150); } // רגל ימין
        ctx.stroke();

        // עדכון המקלדת
        const keyboard = document.getElementById('keyboard');
        keyboard.innerHTML = '';
        const hebrewAlphabet = 'אבגדהוזחטיכלמנסעפצקרשתךםןףץ';
        const isGameOver = mistakes >= 10 || !display.includes('_');
        
        // רק השחקן המנחש יכול להשתמש במקלדת
        if (!isCreator && !isGameOver) {
          for (let letter of hebrewAlphabet) {
            if (!guesses.includes(letter)) {
              const btn = document.createElement('button');
              btn.textContent = letter;
              btn.onclick = () => guessLetter(lobbyId, letter);
              keyboard.appendChild(btn);
            }
          }
        }

        // עדכון סטטוס המשחק
        if (isCreator) {
          const otherPlayer = lobby.players && lobby.players.length > 1 ? lobby.players[1] : "השחקן השני";
          document.getElementById('gameStatus').textContent = 
            `מחכה ל-${otherPlayer} לנחש את המילה: ${word}`;
        } else {
          if (mistakes >= 10) {
            document.getElementById('gameStatus').textContent = `הפסדת! המילה הייתה: ${word}`;
            playSound('loseSound');
            stopGameTimers();
          } else if (!display.includes('_')) {
            document.getElementById('gameStatus').textContent = 'ניצחת! כל הכבוד!';
            playSound('winSound');
            stopGameTimers();
          } else {
            document.getElementById('gameStatus').textContent = `נחש את המילה`;
          }
          
          // עדכון ניקוד כשהמשחק מסתיים
          if (isGameOver && !isCreator) {
            let baseScore = 0;
            if (!display.includes('_')) {  // ניצחון
              baseScore = 10 - mistakes;  // 10 נקודות בסיס פחות הטעויות
              
              // בונוס מהירות - ככל שגמרת מהר יותר, יותר נקודות
              const timeBonus = Math.max(0, 5 - Math.floor(gameTimeTaken / 30));
              
              currentRoundScore = baseScore + timeBonus;
              document.getElementById('scoreDisplay').textContent = `ניקוד: ${currentRoundScore}`;
              
              updateScore(currentRoundScore, gameTimeTaken);
            } else {  // הפסד
              document.getElementById('scoreDisplay').textContent = `ניקוד: 0`;
              updateScore(0, gameTimeTaken);
            }
          }
        }

        // עדכון הצ'אט
        const chat = document.getElementById('chat');
        chat.innerHTML = '';
        if (lobby.chat && Array.isArray(lobby.chat) && lobby.chat.length > 0) {
          lobby.chat.slice(-15).forEach(msg => {
            if (!msg || !msg.nickname) return;
            
            const isSystem = msg.nickname === 'מערכת';
            const isOther = msg.nickname !== currentUserNickname && !isSystem;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = isSystem ? 'chat-message system' : 
                                  isOther ? 'chat-message other' : 'chat-message';
            
            if (!isSystem) {
              const nameSpan = document.createElement('div');
              nameSpan.className = isOther ? 'chat-name other' : 'chat-name';
              nameSpan.textContent = msg.nickname;
              messageDiv.appendChild(nameSpan);
            }
            
            const textSpan = document.createElement('div');
            textSpan.textContent = msg.text;
            messageDiv.appendChild(textSpan);
            
            chat.appendChild(messageDiv);
          });
          chat.scrollTop = chat.scrollHeight;
        }
      }, (error) => {
            console.error("שגיאה בטעינת משחק:", error);
            document.getElementById('gameStatus').textContent = "שגיאה בטעינת המשחק";
            setTimeout(() => exitGame(), 3000);
          });
        })
        .catch((error) => {
          console.error("שגיאה בבדיקת קיום החדר:", error);
          document.getElementById('gameStatus').textContent = "שגיאה בטעינת המשחק";
          setTimeout(() => exitGame(), 3000);
        });
    }

    function guessLetter(lobbyId, letter) {
      if (!letter) return;
      
      // מתחיל טיימר לאות הנוכחית
      startLetterTimer(letter);
      
      // בדיקה שמזהה החדר קיים
      if (!lobbyId) {
        console.error("אין מזהה חדר לשליחת ניחוש");
        return;
      }
      
      console.log("שולח ניחוש:", letter, "לחדר:", lobbyId);
      
      realtimeDb.ref('lobbies/' + lobbyId).transaction((lobby) => {
        if (!lobby) {
          console.error("החדר לא קיים");
          return null;
        }
        
        // בדיקה שהמשחק פעיל ושהמשתמש הוא המנחש (לא היוצר)
        if ((lobby.status === 'full' || lobby.status === 'active') && lobby.creator !== currentUserNickname) {
          // וודא שמערכי הנתונים קיימים
          lobby.guesses = Array.isArray(lobby.guesses) ? lobby.guesses : [];
          
          if (!lobby.guesses.includes(letter)) {
            // הוסף את האות לרשימת הניחושים
            lobby.guesses.push(letter);
            
            // בדוק אם האות קיימת במילה
            if (!lobby.word || typeof lobby.word !== 'string') {
              console.error("המילה חסרה או לא תקינה");
            } else if (!lobby.word.includes(letter)) {
              lobby.mistakes = (lobby.mistakes || 0) + 1;
              // הצליל יופעל בעת קבלת העדכון, לא כאן
            } else {
              // הצליל יופעל בעת קבלת העדכון, לא כאן
            }
            
            // עדכן את זמן העדכון האחרון
            lobby.lastUpdate = firebase.database.ServerValue.TIMESTAMP;
          }
        } else {
          console.log("לא ניתן לנחש - או שהמשחק לא פעיל או שאתה יוצר החדר");
        }
        
        return lobby;
      }).then(() => {
        // עצור טיימר לאות הנוכחית לאחר שהעסקה הסתיימה
        stopLetterTimer(letter);
      }).catch((error) => {
        console.error("שגיאה בניחוש:", error);
        stopLetterTimer(letter);
      });
    }

    function sendChat() {
      const message = document.getElementById('chatInput').value.trim();
      if (!message) {
        console.log("אין הודעה להוסיף");
        return;
      }
      
      if (!currentLobbyId) {
        console.log("לא נמצא מזהה חדר נוכחי");
        return;
      }
      
      if (!currentUserNickname) {
        console.log("לא נמצא כינוי משתמש נוכחי");
        return;
      }
      
      console.log(`שולח הודעה לחדר ${currentLobbyId}`);
      
      // קבל את מערך הצ'אט הנוכחי
      realtimeDb.ref('lobbies/' + currentLobbyId + '/chat').once('value')
        .then((snapshot) => {
          let chatArray = [];
          
          if (snapshot.exists() && Array.isArray(snapshot.val())) {
            chatArray = snapshot.val();
          }
          
          // הוסף את ההודעה החדשה
          const newMessage = {
            nickname: currentUserNickname,
            text: message,
            timestamp: Date.now()
          };
          
          chatArray.push(newMessage);
          console.log("הודעה נוספה למערך הצ'אט");
          
          // הגבל את גודל הצ'אט ל-50 הודעות
          if (chatArray.length > 50) {
            chatArray = chatArray.slice(-50);
          }
          
          // עדכן את המערך בדאטאבייס
          return realtimeDb.ref('lobbies/' + currentLobbyId).update({
            chat: chatArray
          });
        })
        .then(() => {
          console.log("הצ'אט עודכן בהצלחה");
          document.getElementById('chatInput').value = '';
        })
        .catch((error) => {
          console.error("שגיאה בשליחת הודעה:", error);
          alert("שגיאה בשליחת הודעה: " + error.message);
        });
    }
    
    // הוסף מאזין אירועים לכפתור Enter בשדה הצ'אט
    document.addEventListener('DOMContentLoaded', function() {
      const chatInput = document.getElementById('chatInput');
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendChat();
        }
      });
    });

    function updateScore(points, timeTaken) {
      const user = auth.currentUser;
      if (!user) return;
      
      // קבל את נתוני המשתמש הקיימים
      db.collection('users').doc(user.uid).get()
        .then((doc) => {
          if (doc.exists) {
            const userData = doc.data();
            const currentScore = userData.score || 0;
            const gamesPlayed = userData.games_played || 0;
            const totalTime = (userData.avg_time || 0) * gamesPlayed;
            
            // חישוב ממוצע זמן חדש
            const newGamesPlayed = gamesPlayed + 1;
            const newTotalTime = totalTime + timeTaken;
            const newAvgTime = newGamesPlayed > 0 ? newTotalTime / newGamesPlayed : 0;
            
            console.log(`עדכון ניקוד: ${points} נקודות, זמן: ${timeTaken} שניות`);
            
            // עדכון נתוני המשתמש
            return db.collection('users').doc(user.uid).update({
              score: currentScore + points,
              games_played: newGamesPlayed,
              avg_time: newAvgTime,
              last_game_score: points,
              last_game_time: timeTaken,
              last_updated: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        })
        .then(() => {
          // רענון טבלת המובילים לאחר עדכון הניקוד
          console.log("ניקוד עודכן, מרענן טבלת מובילים");
          
          // השהייה קצרה לאפשר לשרת לעדכן את הנתונים
          setTimeout(() => {
            loadLeaderboard();
          }, 1000);
          
          // הודעה למשתמש
          const currentPoints = points > 0 ? 
            `כל הכבוד! קיבלת ${points} נקודות!` : 
            `המשחק הסתיים, לא קיבלת נקודות הפעם.`;
          
          document.getElementById('gameStatus').textContent += ` ${currentPoints}`;
        })
        .catch((error) => console.error("שגיאה בעדכון ניקוד:", error));
    }

    function exitGame() {
      if (!currentLobbyId) {
        document.getElementById('gameContainer').classList.add('hidden');
        document.getElementById('homeContainer').classList.remove('hidden');
        return;
      }
      
      // ניקוי טיימרים
      stopGameTimers();
      
      // ניתוק האזנות
      realtimeDb.ref('lobbies/' + currentLobbyId).off();
      
      // בדיקה אם המשתמש הוא יוצר החדר
      realtimeDb.ref('lobbies/' + currentLobbyId).once('value')
        .then((snapshot) => {
          if (snapshot.exists()) {
            const lobby = snapshot.val();
            
            // אם המשתמש הוא יוצר החדר, מחק אותו
            if (lobby.creator === currentUserNickname) {
              return realtimeDb.ref('lobbies/' + currentLobbyId).remove();
            } 
            // אחרת, עדכן את החדר
            else if (lobby.players && Array.isArray(lobby.players)) {
              const updatedPlayers = lobby.players.filter(player => player !== currentUserNickname);
              
              // הוסף הודעת מערכת על עזיבה
              let chatArray = Array.isArray(lobby.chat) ? [...lobby.chat] : [];
              chatArray.push({
                nickname: 'מערכת',
                text: `${currentUserNickname} עזב את המשחק`,
                timestamp: Date.now()
              });
              
              return realtimeDb.ref('lobbies/' + currentLobbyId).update({
                players: updatedPlayers,
                chat: chatArray,
                status: 'ended'  // המשחק הסתיים
              });
            }
          }
        })
        .catch((error) => console.error("שגיאה ביציאה ממשחק:", error))
        .finally(() => {
          currentLobbyId = null;
          document.getElementById('gameContainer').classList.add('hidden');
          document.getElementById('homeContainer').classList.remove('hidden');
          
          // רענון רשימת החדרים
          realtimeDb.ref('global_updates/lobbies').set(Date.now());
          loadLobbies();
        });
    }
  </script>
</body>
</html>
