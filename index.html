
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>砖 转 </title>

  <!-- Firebase SDK Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      background: #f5f9fc;
      color: rgba(0,0,0,0.87);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      direction: rtl;
      text-align: center;
      min-height: 100vh;
    }
    .container {
      background: white;
      max-width: 800px;
      margin: 20px auto;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    h1 { 
      font-size: 28px; 
      color: #2c3e50; 
      margin-bottom: 20px;
    }
    h2 {
      font-size: 22px;
      color: #3498db;
      margin: 20px 0 15px;
    }
    p { 
      font-size: 16px; 
      margin: 12px 0; 
      color: #34495e;
    }
    input {
      width: 80%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border 0.3s;
    }
    input:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 5px rgba(52,152,219,0.5);
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
      font-size: 15px;
      transition: background 0.3s, transform 0.1s;
    }
    button:hover { 
      background: #2980b9; 
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(1px);
    }
    button:disabled { 
      background: #95a5a6; 
      cursor: not-allowed; 
      transform: none;
    }
    .btn-primary {
      background: #3498db;
    }
    .btn-success {
      background: #2ecc71;
    }
    .btn-danger {
      background: #e74c3c;
    }
    .btn-warning {
      background: #f39c12;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 20px 0; 
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { 
      padding: 12px 15px; 
      text-align: center;
    }
    th { 
      background: #3498db; 
      color: white;
      font-weight: 600;
    }
    tr:nth-child(even) { 
      background: #f2f6f9; 
    }
    tr:hover {
      background: #e8f4fb;
    }
    .hidden { 
      display: none; 
    }
    #wordDisplay {
      font-size: 40px;
      letter-spacing: 8px;
      margin: 25px 0;
      white-space: pre;
      color: #2c3e50;
      min-height: 50px;
    }
    #hangmanCanvas { 
      margin: 20px auto; 
      display: block;
      border-radius: 8px;
      background: #f9f9f9;
    }
    #keyboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      max-width: 600px;
      margin: 20px auto;
    }
    #keyboard button {
      min-width: 40px;
      font-size: 18px;
    }
    #chat {
      border: 1px solid #ddd;
      height: 180px;
      overflow-y: auto;
      margin: 20px 0;
      padding: 15px;
      text-align: right;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .chat-message {
      margin: 8px 0;
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 80%;
      word-wrap: break-word;
      position: relative;
      clear: both;
      background: #e8f4fb;
      float: right;
    }
    .chat-message.system {
      background: #e9ebef;
      color: #7f8c8d;
      margin: 5px auto;
      float: none;
      text-align: center;
      font-style: italic;
      font-size: 14px;
    }
    .chat-message.other {
      background: #efffef;
      float: left;
    }
    .chat-name {
      font-weight: bold;
      margin-bottom: 3px;
      color: #2980b9;
    }
    .chat-name.other {
      color: #27ae60;
    }
    #timerDisplay {
      font-size: 20px;
      margin: 10px 0;
      color: #e74c3c;
      font-weight: bold;
    }
    .round-info {
      display: flex;
      justify-content: space-around;
      margin: 15px auto;
      max-width: 500px;
      background: #f2f6f9;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
    }
    .game-counter {
      background: #3498db;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 5px;
    }
    .lobby-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .lobby-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .invite-link {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 5px;
      border: 1px dashed #ddd;
      font-size: 14px;
      margin: 10px 0;
      word-break: break-all;
    }
    #soundToggle {
      position: fixed;
      top: 10px;
      left: 10px;
      background: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 100;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      .container {
        padding: 15px;
        margin: 10px;
      }
      #wordDisplay {
        font-size: 30px;
        letter-spacing: 5px;
      }
      #keyboard button {
        min-width: 30px;
        font-size: 16px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- 驻转专 砖 爪 -->
  <div id="soundToggle" onclick="toggleSound()"></div>

  <!-- 爪 -->
  <audio id="correctSound" src="https://www.soundjay.com/buttons/button-09a.mp3" preload="auto"></audio>
  <audio id="wrongSound" src="https://www.soundjay.com/buttons/button-10.mp3" preload="auto"></audio>
  <audio id="winSound" src="https://www.soundjay.com/human/human-crowd-cheer-01.mp3" preload="auto"></audio>
  <audio id="loseSound" src="https://www.soundjay.com/human/human-groan-01.mp3" preload="auto"></audio>
  <audio id="tickSound" src="https://www.soundjay.com/mechanical/mechanical-clock-ticking-1.mp3" preload="auto"></audio>

  <!-- 驻住 转专转/专砖 -->
  <div id="authContainer" class="container">
    <h1>专  砖 转 </h1>
    <p>转专  专砖  转 砖拽</p>
    <input type="email" id="email" placeholder="">
    <input type="password" id="password" placeholder="住住">
    <input type="text" id="nickname" placeholder="">
    <button class="btn-primary" onclick="signUp()">专砖</button>
    <button class="btn-success" onclick="signIn()">转专</button>
    <p id="status"></p>
  </div>

  <!-- 祝 转 -->
  <div id="homeContainer" class="container hidden">
    <h1 id="welcomeMessage">专 !</h1>
    <button class="btn-danger" onclick="signOut()">转转拽</button>
    
    <h2>转 </h2>
    <table id="leaderboard">
      <tr><th></th><th>拽</th><th>砖拽</th><th> 爪注</th></tr>
    </table>
    
    <!-- 驻住 爪专驻转 爪注转 拽 -->
    <div>
      <h3>爪专祝 砖拽 注 拽</h3>
      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <input type="text" id="joinGameCode" placeholder="住 拽 砖拽" style="flex:1;">
        <button class="btn-primary" onclick="joinGameWithCode()">爪专祝</button>
      </div>
    </div>
    
    <h2>专 转</h2>
    <div id="lobbies"></div>
    
    <div>
      <button class="btn-success" onclick="createLobby()">爪专 砖拽 砖</button>
      <button class="btn-primary" onclick="showInviteForm()"> 砖拽 注 拽</button>
    </div>
    
    <!-- 驻住 转 砖拽 -->
    <div id="inviteForm" class="hidden">
      <h3>转 砖拽</h3>
      <input type="text" id="gameWord" placeholder="住  砖拽">
      <button class="btn-success" onclick="createDirectInvite()">爪专 拽 </button>
      <div id="inviteLink" class="invite-link hidden"></div>
    </div>
  </div>

  <!-- 住 砖拽 -->
  <div id="gameContainer" class="container hidden">
    <h1>砖 转 - 砖拽</h1>
    <p id="gameStatus"></p>
    
    <div class="round-info">
      <div>
        <span id="mistakesCount">注转: 0/10</span>
      </div>
      <div id="timerDisplay">: 00:00</div>
      <div>
        <span id="scoreDisplay">拽: 0</span>
      </div>
    </div>
    
    <div id="wordDisplay"></div>
    <canvas id="hangmanCanvas" width="200" height="200"></canvas>
    <div id="keyboard"></div>
    <div id="chat"></div>
    <div style="display: flex; gap: 10px;">
      <input type="text" id="chatInput" placeholder="转 注" style="flex: 1;">
      <button class="btn-primary" onclick="sendChat()">砖</button>
    </div>
    <button class="btn-danger" onclick="exitGame()">专 祝 转</button>
  </div>

  <script>
    console.log("住拽专驻 注");

    const firebaseConfig = {
      apiKey: "AIzaSyBiKGygJc5u4tQeebDVCD8_AP1r6kgm4Lc",
      authDomain: "hangmanonline-902ac.firebaseapp.com",
      databaseURL: "https://hangmanonline-902ac-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hangmanonline-902ac",
      storageBucket: "hangmanonline-902ac.firebasestorage.app",
      messagingSenderId: "577708158727",
      appId: "1:577708158727:web:e1aafd176c77df7d801fa2"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const realtimeDb = firebase.database();

    if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
      console.log("专抓 -Emulator 拽");
      auth.useEmulator("http://localhost:9099");
      db.useEmulator("localhost", 8080);
      realtimeDb.useEmulator("localhost", 9000);
    }
    
    // 驻转专 注转 转专转 砖专 转专 驻专住
    if (document.getElementById('firebaseConnectionError')) {
      document.getElementById('firebaseConnectionError').style.display = 'none';
    }
    
    // 住驻转  转专转 专 驻专住
    const connectionAlert = document.createElement('div');
    connectionAlert.id = 'firebaseConnectionAlert';
    connectionAlert.style.position = 'fixed';
    connectionAlert.style.bottom = '10px';
    connectionAlert.style.right = '10px';
    connectionAlert.style.padding = '15px';
    connectionAlert.style.background = '#f8d7da';
    connectionAlert.style.color = '#721c24';
    connectionAlert.style.borderRadius = '5px';
    connectionAlert.style.zIndex = '1000';
    connectionAlert.style.display = 'none';
    connectionAlert.style.maxWidth = '350px';
    connectionAlert.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
    connectionAlert.innerHTML = `
      <p style="margin: 0; font-weight:bold; font-size:16px">注  专 砖专转</p>
      <p style="margin: 5px 0">转 砖注   :</p>
      <ol style="margin: 5px 0; padding-right: 20px; text-align: right">
        <li>转 砖 专砖转  驻专 砖</li>
        <li>住转 DNS 砖 住驻拽 专</li>
        <li>专转 Firebase  注转</li>
      </ol>
      <p style="margin: 5px 0; font-weight:bold">驻转专转 驻砖专:</p>
      <ol style="margin: 5px 0; padding-right: 20px; text-align: right">
        <li>砖 转 砖专转 -DNS 砖专转 爪专 (8.8.8.8  1.1.1.1)</li>
        <li>住 转专 专 专砖转 专 专转 (砖 专 住专)</li>
        <li> 砖 ${window.location.hostname} 专砖 -Firebase</li>
      </ol>
      <div style="margin-top:10px">
        <button onclick="retryConnection()" style="background:#0275d8; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer">住 砖</button>
        <button onclick="this.parentElement.parentElement.style.display='none'" style="background:#6c757d; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer">住专</button>
      </div>
    `;
    document.body.appendChild(connectionAlert);

    // 砖转 
    let currentLobbyId = null;
    let currentUserNickname = null;
    let gameTimer = null;
    let gameStartTime = null;
    let gameTimeTaken = 0;
    let letterTimers = {};
    let currentRoundScore = 0;
    let soundEnabled = true;
    let joinTransactionTimeout = null; // 专  转 爪专驻转

    // 拽转 驻专专 -URL
    function checkUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const inviteId = urlParams.get('invite');
      
      //  砖 拽  -URL
      if (inviteId) {
        console.log("转拽 拽 :", inviteId);
        //  注 砖专砖专 砖 驻专专, 拽 转 -URL
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // 砖专转 拽  砖砖 专 转专转
        sessionStorage.setItem('pendingInvite', inviteId);
      }
    }
    
    // 拽转 拽  注转 祝
    window.addEventListener('load', () => {
      // 拽  砖转 爪 注 砖
      window.joiningLobby = false;
      if (joinTransactionTimeout) {
        clearTimeout(joinTransactionTimeout);
        joinTransactionTimeout = null;
      }
      
      checkUrlParams();
    });
    
    // 驻拽爪 拽转 转 转转 专 转专转
    function checkPendingInvites() {
      const pendingInvite = sessionStorage.getItem('pendingInvite');
      if (pendingInvite) {
        console.log("砖  转:", pendingInvite);
        sessionStorage.removeItem('pendingInvite');
        
        // 拽 砖 注 拽转 转拽驻
        realtimeDb.ref('invites/' + pendingInvite).once('value')
          .then((snapshot) => {
            if (snapshot.exists()) {
              const invite = snapshot.val();
              // 拽转 转拽祝  (24 砖注转)
              if (Date.now() - invite.created < 24 * 60 * 60 * 1000) {
                return joinInvitedLobby(invite.lobbyId);
              } else {
                alert("  驻 转拽祝");
              }
            } else {
              alert("  爪  砖 专 砖");
            }
          })
          .catch((error) => {
            console.error("砖 拽转 :", error);
          });
      }
    }

    // 驻拽爪 砖转拽转/驻注转 爪
    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById('soundToggle').innerHTML = soundEnabled ? '' : '';
    }
    
    // 驻拽爪 住 专 砖 砖专转
    function retryConnection() {
      console.log("住 转专 砖 砖专转 Firebase...");
      document.getElementById('lobbies').innerHTML = '<div class="loader"></div><p>住 转专 砖...</p>';
      
      // 住 转 砖 转 专 Firebase
      try {
        // 专注 拽 转
        if (auth.currentUser) {
          auth.currentUser.getIdToken(true)
            .then(() => console.log("拽 转 专注 爪"))
            .catch(e => console.error("砖 专注 拽:", e));
        }
      } catch (e) {
        console.error("砖 住 专注 专:", e);
      }
      
      // 拽转 专 砖
      realtimeDb.ref('.info/connected').once('value')
        .then((snapshot) => {
          if (snapshot.val() === true) {
            console.log("专 爪!");
            
            // 住转专 转 转专
            if (document.getElementById('firebaseConnectionAlert')) {
              document.getElementById('firebaseConnectionAlert').style.display = 'none';
            }
            
            loadLobbies();
          } else {
            console.error("注  专 砖专转");
            
            // 爪 注 驻专 注 注转 专
            document.getElementById('lobbies').innerHTML = 
              '<div style="background:#f8d7da; padding:15px; border-radius:8px; margin:10px 0; text-align:right">' +
              '<p style="font-weight:bold; font-size:18px"> 专 砖专转</p>' +
              '<p>转  注 转 驻砖专转 转:</p>' +
              '<ol>' +
              '<li><strong>住 专:</strong> 转 砖专 专 砖 住 砖 砖专转 Firebase</li>' +
              '<li><strong>转 DNS:</strong> 住驻拽 专 砖 注砖 住 转  砖 Firebase</li>' +
              '<li><strong>专转 Firebase:</strong>  爪专 住祝 转   专转</li>' +
              '</ol>' +
              '<p><strong>爪注转 驻转专:</strong></p>' +
              '<ol>' +
              '<li>砖 转 砖专转 -DNS 砖专转 爪专 (Google: 8.8.8.8  Cloudflare: 1.1.1.1)</li>' +
              '<li>住 砖转砖 专砖转 专 专转 (砖 专 住专)</li>' +
              '<li> 转  转专, 住祝 转  <code>' + window.location.hostname + '</code> 专转 Firebase</li>' +
              '</ol>' +
              '<p><button onclick="retryConnection()" class="btn-primary">住 转专 砖</button></p>' +
              '</div>';
          }
        })
        .catch(error => {
          console.error("砖 拽转 专:", error);
          document.getElementById('lobbies').innerHTML = 
            '<p>砖转 转专转: ' + error.message + '</p>' +
            '<button onclick="retryConnection()" class="btn-primary">住 砖</button>' +
            '<p>住 专注 转 祝  拽 转 专 专 砖</p>';
        });
    }
    
    // 驻拽爪 砖驻专转 砖注转 爪 砖拽转 砖爪 驻注
    function playSound(soundId) {
      if (!soundEnabled) return;
      
      const sound = document.getElementById(soundId);
      if (sound) {
        // 驻住 爪 驻 驻注 砖
        sound.pause();
        sound.currentTime = 0;
        sound.play().catch(e => console.error("砖 砖注转 爪:", e));
      }
    }
    
    // 驻拽爪转 专注   拽
    function setupAutoRefresh() {
      setInterval(() => {
        if (auth.currentUser && currentUserNickname) {
          console.log("爪注 专注 转 ");
          loadLobbies();
        }
      }, 60000); //  拽
    }
    
    // 驻 专注 转拽
    function setupConnectionMonitoring() {
      realtimeDb.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
          console.log("专 砖专转 Firebase");
          
          // 砖专 转专 砖 - 注 转 砖转砖 拽
          if (auth.currentUser && currentUserNickname) {
            realtimeDb.ref('online_users/' + auth.currentUser.uid).set({
              nickname: currentUserNickname,
              last_active: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              console.log("注 住住 拽 爪");
              // 专注 转 专砖转 专 专 专 砖
              loadLobbies();
            });
          }
        } else {
          console.log("转拽 砖专转 Firebase");
        }
      });
    }
    
    auth.onAuthStateChanged((user) => {
      if (user) {
        console.log("砖转砖 专:", user.uid);
        document.getElementById('authContainer').classList.add('hidden');
        document.getElementById('homeContainer').classList.remove('hidden');
        document.getElementById('gameContainer').classList.add('hidden');
        loadUserData(user);
        
        // 专转 专注  专 专
        setupAutoRefresh();
        setupConnectionMonitoring();
        
        //  注 
        setupGlobalUpdatesListener();
        
        // 拽转 转 转转
        checkPendingInvites();
      } else {
        console.log("砖转砖  专");
        document.getElementById('authContainer').classList.remove('hidden');
        document.getElementById('homeContainer').classList.add('hidden');
        document.getElementById('gameContainer').classList.add('hidden');
        currentUserNickname = null;
        currentLobbyId = null;
        
        // 拽 专 转拽 转
        stopGameTimers();
        
        // 专 转  住 转
        realtimeDb.ref('lobbies').off();
        realtimeDb.ref('.info/connected').off();
        realtimeDb.ref('global_updates').off();
      }
    });
    
    //  专
    function startGameTimer() {
      stopGameTimers(); // 拽 专 拽
      
      gameStartTime = Date.now();
      gameTimeTaken = 0;
      
      gameTimer = setInterval(() => {
        const elapsedSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        
        document.getElementById('timerDisplay').textContent = 
          `: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // 拽   爪 "拽 拽" 砖砖专 驻转 -10 砖转
        if (minutes === 0 && seconds >= 50 && seconds <= 59) {
          if (soundEnabled && seconds % 2 === 0) {
            playSound('tickSound');
          }
        }
      }, 1000);
    }
    
    function startLetterTimer(letter) {
      // 注拽 专   转
      letterTimers[letter] = {
        startTime: Date.now()
      };
    }
    
    function stopLetterTimer(letter) {
      if (letterTimers[letter]) {
        letterTimers[letter].endTime = Date.now();
        letterTimers[letter].timeTaken = 
          (letterTimers[letter].endTime - letterTimers[letter].startTime) / 1000;
      }
    }
    
    function stopGameTimers() {
      if (gameTimer) {
        clearInterval(gameTimer);
        gameTimer = null;
      }
      
      if (gameStartTime) {
        gameTimeTaken = (Date.now() - gameStartTime) / 1000;
      }
      
      // 驻住 专 砖 转转
      letterTimers = {};
    }
    
    // 驻拽爪 爪转 驻住 爪专转  砖专
    function showInviteForm() {
      const inviteForm = document.getElementById('inviteForm');
      if (inviteForm.classList.contains('hidden')) {
        inviteForm.classList.remove('hidden');
      } else {
        inviteForm.classList.add('hidden');
        document.getElementById('inviteLink').classList.add('hidden');
      }
    }
    
    // 驻拽爪 爪专转  砖专
    function createDirectInvite() {
      const word = document.getElementById('gameWord').value.trim();
      if (!word || !/^[-转祝抓 ]+$/.test(word)) {
        return alert("砖   转拽 (转转 注专转 专 )");
      }
      
      // 爪专转  砖
      realtimeDb.ref('lobbies').push({
        creator: currentUserNickname,
        status: 'waiting',
        players: [currentUserNickname],
        word: word.toLowerCase(),
        guesses: [],
        mistakes: 0,
        chat: [],
        isPrivate: true, //  驻专 砖 驻注 专砖 转
        createdAt: firebase.database.ServerValue.TIMESTAMP
      }).then((result) => {
        const lobbyId = result.key;
        
        // 爪专转 拽 
        const inviteId = generateInviteCode();
        
        // 砖专转 
        return realtimeDb.ref('invites/' + inviteId).set({
          lobbyId: lobbyId,
          creator: currentUserNickname,
          created: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          // 转 拽砖专 
          const inviteLink = `${window.location.origin}${window.location.pathname}?invite=${inviteId}`;
          
          // 爪转 拽砖专 砖转砖
          const inviteLinkElement = document.getElementById('inviteLink');
          inviteLinkElement.textContent = inviteLink;
          inviteLinkElement.classList.remove('hidden');
          
          return inviteLink;
        });
      }).catch((error) => {
        console.error("砖 爪专转  砖专:", error);
        alert("砖 爪专转 : " + error.message);
      });
    }
    
    // 驻拽爪 爪专转 拽  拽专
    function generateInviteCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }
    
    // 驻拽爪 爪专驻转 砖拽 注 拽
    function joinGameWithCode() {
      const gameCode = document.getElementById('joinGameCode').value.trim().toUpperCase();
      
      if (!gameCode) {
        return alert("砖  拽 砖拽");
      }
      
      console.log("住 爪专祝 砖拽 注 拽:", gameCode);
      
      // 拽转 专 驻 住 爪专驻转
      realtimeDb.ref('.info/connected').once('value')
        .then((snapshot) => {
          if (snapshot.val() !== true) {
            throw new Error(" 专 砖专转.  专注 转 祝 住转 砖");
          }
          
          // 驻砖  专 注 驻 拽 砖拽
          return realtimeDb.ref('game_codes/' + gameCode).once('value');
        })
        .then((snapshot) => {
          if (!snapshot.exists()) {
            throw new Error("拽 砖拽  拽");
          }
          
          const gameData = snapshot.val();
          const lobbyId = gameData.lobbyId;
          
          if (!lobbyId) {
            throw new Error("转 砖拽 住专");
          }
          
          console.log("爪 专 注 拽:", lobbyId);
          
          // 拽 砖专 注 拽
          return realtimeDb.ref('lobbies/' + lobbyId).once('value')
            .then(lobbySnapshot => {
              if (!lobbySnapshot.exists()) {
                throw new Error("专 砖拽  爪");
              }
              
              // 转转 转 爪专驻转
              return joinLobby(lobbyId, true);
            });
        })
        .catch((error) => {
          console.error("砖 爪专驻转 注 拽:", error);
          alert("砖 爪专驻转: " + error.message);
        });
    }
    
    // 驻拽爪 爪专驻转  专 
    function joinInvitedLobby(lobbyId) {
      console.log("住 爪专祝  专 :", lobbyId);
      
      if (!lobbyId) {
        console.error(" 专  转拽");
        alert("拽砖专   转拽");
        return;
      }
      
      // 拽 砖 拽
      realtimeDb.ref('lobbies/' + lobbyId).once('value')
        .then((snapshot) => {
          if (!snapshot.exists()) {
            throw new Error("专 砖拽  爪");
          }
          
          const lobby = snapshot.val();
          
          // 拽 砖 爪 转
          if (lobby.status !== 'waiting') {
            throw new Error("专 砖拽 专 ");
          }
          
          // 拽 砖转  爪专 
          if (lobby.creator === currentUserNickname) {
            throw new Error("转 专 爪专 专 ");
          }
          
          // 转转 转 爪专驻转
          console.log("转 转 爪专驻转 专 ");
          return joinLobby(lobbyId, true);
        })
        .catch((error) => {
          console.error("砖 爪专驻转  专 :", error);
          alert("砖 爪专驻转 专: " + error.message);
        });
    }
    
    // 驻拽爪 砖驻专转 爪专转  砖专 注 拽
    function createDirectInvite() {
      const word = document.getElementById('gameWord').value.trim();
      if (!word || !/^[-转祝抓 ]+$/.test(word)) {
        return alert("砖   转拽 (转转 注专转 专 )");
      }
      
      // 爪专转 拽 砖拽 
      const gameCode = generateInviteCode();
      
      // 爪专转  砖
      realtimeDb.ref('lobbies').push({
        creator: currentUserNickname,
        status: 'waiting',
        players: [currentUserNickname],
        word: word.toLowerCase(),
        guesses: [],
        mistakes: 0,
        chat: [],
        gameCode: gameCode, // 拽 砖拽
        isPrivate: true, //  驻专 砖 驻注 专砖 转
        createdAt: firebase.database.ServerValue.TIMESTAMP
      }).then((result) => {
        const lobbyId = result.key;
        
        // 砖专转 拽砖专  爪 专 驻 拽
        return realtimeDb.ref('game_codes/' + gameCode).set({
          lobbyId: lobbyId,
          creator: currentUserNickname,
          created: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          // 爪转 拽 砖转砖
          const inviteLinkElement = document.getElementById('inviteLink');
          inviteLinkElement.textContent = `拽 : ${gameCode}`;
          inviteLinkElement.classList.remove('hidden');
          
          alert(`砖拽 爪专! 拽 : ${gameCode}`);
          
          return gameCode;
        });
      }).catch((error) => {
        console.error("砖 爪专转  砖专:", error);
        alert("砖 爪专转 : " + error.message);
      });
    }
    
    // 驻拽爪 砖  注 
    function setupGlobalUpdatesListener() {
      //  砖 专砖转 专
      realtimeDb.ref('global_updates/lobbies').on('value', (snapshot) => {
        if (snapshot.exists() && auth.currentUser) {
          console.log("转拽 注  专砖转 专");
          loadLobbies();
        }
      }, (error) => console.error("砖  注 :", error));
    }

    function signUp() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const nickname = document.getElementById('nickname').value;
      
      if (!email || !password) {
        return document.getElementById('status').textContent = "砖   住住";
      }
      
      if (!nickname) {
        return document.getElementById('status').textContent = " 专 ";
      }
      
      document.getElementById('status').textContent = "转专...";
      
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          return db.collection('users').doc(userCredential.user.uid).set({ 
            nickname, 
            score: 0,
            games_played: 0,
            avg_time: 0,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });
        })
        .then(() => {
          document.getElementById('status').textContent = "专砖转 爪!";
        })
        .catch((error) => {
          document.getElementById('status').textContent = "砖: " + error.message;
        });
    }

    function signIn() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        return document.getElementById('status').textContent = "砖   住住";
      }
      
      document.getElementById('status').textContent = "转专...";
      
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById('status').textContent = "转专转 爪!";
        })
        .catch((error) => {
          document.getElementById('status').textContent = "砖: " + error.message;
        });
    }

    function signOut() {
      auth.signOut().then(() => {
        console.log("转转拽转 爪注 爪");
      }).catch((error) => {
        console.error("砖 转转拽转:", error);
      });
    }

    function loadUserData(user) {
      db.collection('users').doc(user.uid).get()
        .then((doc) => {
          if (doc.exists) {
            currentUserNickname = doc.data().nickname;
            document.getElementById('welcomeMessage').textContent = `专  ${currentUserNickname}!`;
            loadLeaderboard();
            loadLobbies();
          } else {
            console.error("砖转砖 拽   转 驻专住专");
            // 爪专 专砖 砖转砖    拽
            if (user.email) {
              db.collection('users').doc(user.uid).set({
                nickname: user.email.split('@')[0],
                score: 0,
                games_played: 0,
                avg_time: 0,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              }).then(() => {
                loadUserData(user); // 注 砖 专 爪专转 转
              });
            }
          }
        })
        .catch((error) => {
          console.error("砖 注转 砖转砖:", error);
        });
    }

    function loadLeaderboard() {
      const leaderboard = document.getElementById('leaderboard');
      leaderboard.innerHTML = '<tr><th></th><th>拽</th><th>砖拽</th><th> 爪注</th></tr>';
      
      // 住驻转 拽专 注
      leaderboard.innerHTML += '<tr><td colspan="4"><div class="loader"></div></td></tr>';
      
      db.collection('users').orderBy('score', 'desc').limit(5).get()
        .then((querySnapshot) => {
          // 住专转 拽专 注
          leaderboard.innerHTML = '<tr><th></th><th>拽</th><th>砖拽</th><th> 爪注</th></tr>';
          
          if (!querySnapshot.empty) {
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const avgTime = data.avg_time ? data.avg_time.toFixed(1) + 's' : '-';
              leaderboard.innerHTML += `
                <tr>
                  <td>${data.nickname || '-'}</td>
                  <td>${data.score || 0}</td>
                  <td>${data.games_played || 0}</td>
                  <td>${avgTime}</td>
                </tr>`;
            });
          } else {
            leaderboard.innerHTML += '<tr><td colspan="4"> 转 注</td></tr>';
          }
        })
        .catch((error) => {
          console.error("砖 注转 转 :", error);
          leaderboard.innerHTML = '<tr><th></th><th>拽</th><th>砖拽</th><th> 爪注</th></tr>';
          leaderboard.innerHTML += '<tr><td colspan="4">砖 注转 转</td></tr>';
        });
    }

    function loadLobbies() {
      const lobbiesDiv = document.getElementById('lobbies');
      lobbiesDiv.innerHTML = '<div class="loader"></div>';
      
      //  砖砖转砖 专
      if (!currentUserNickname || !auth.currentUser) {
        console.log(" 砖转砖 专,  注 专");
        lobbiesDiv.innerHTML = '<p>砖 转专  专转 专</p>';
        return;
      }
      
      console.log("注 专 注专 砖转砖:", currentUserNickname);
      
      // 拽 拽 转 爪 专 砖专转
      realtimeDb.ref('.info/connected').once('value')
        .then((connectedSnapshot) => {
          if (connectedSnapshot.val() !== true) {
            console.error(" 专 砖专转 Firebase");
            
            // 爪 转专 专 砖专 
            if (document.getElementById('firebaseConnectionAlert')) {
              document.getElementById('firebaseConnectionAlert').style.display = 'block';
              
              // 住转专 专 30 砖转
              setTimeout(() => {
                document.getElementById('firebaseConnectionAlert').style.display = 'none';
              }, 30000);
            }
            
            lobbiesDiv.innerHTML = 
              '<p> 专 砖专转. <button onclick="retryConnection()" class="btn-primary">住 转专 砖</button></p>' +
              '<div id="firebaseConnectionError">' +
              '<p>砖 :  转 砖转砖 专住 驻专住转 砖 转专, 砖 住祝 转   专转 Firebase:</p>' +
              '<code>' + window.location.hostname + '</code>' +
              '<p>砖 住 拽住转 Firebase > Authentication > Domains 住祝 转 转转 </p>' +
              '</div>';
            
            // 住 住祝  专 5 砖转
            setTimeout(() => retryConnection(), 5000);
            return;
          }
        
        console.log("专 砖专转 Firebase 驻注");
        
        // 注 住住 拽
        realtimeDb.ref('online_users/' + auth.currentUser.uid).set({
          nickname: currentUserNickname,
          last_active: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          console.log("住住 拽 注 爪");
        }).catch(error => {
          console.error("砖 注 住住 拽:", error);
        });
        
        // 注 专砖转 专 转
        realtimeDb.ref('lobbies_list').update({
          lastUpdate: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          console.log("专砖转 专 转 注");
        }).catch(error => {
          console.error("砖 注 专砖转 专 转:", error);
        });
        
        // 住专转 转 拽转
        realtimeDb.ref('lobbies').off();
        
        //  专砖转 专
        realtimeDb.ref('lobbies').on('value', (snapshot) => {
          lobbiesDiv.innerHTML = '';
          
          if (!snapshot.exists()) {
            console.log(" 专 驻转 住");
            lobbiesDiv.innerHTML = '<p> 专 驻转 专注</p>';
            return;
          }
          
          let openLobbies = [];
          let userLobbies = [];
          let activeGames = [];
          
          snapshot.forEach((childSnapshot) => {
            try {
              const lobby = childSnapshot.val();
              const lobbyId = childSnapshot.key;
              
              // 拽转 转拽转 拽驻转
              if (!lobby || typeof lobby !== 'object') {
                console.log("爪 专  转拽:", lobbyId);
                return;
              }
              
              //  砖 砖转 专砖 拽
              if (!lobby.creator || !lobby.status) {
                console.log("专 住专 转 住住:", lobbyId);
                
                // 住 拽转 专  转拽
                realtimeDb.ref('lobbies/' + lobbyId).remove()
                  .then(() => console.log("专  转拽 拽:", lobbyId))
                  .catch(e => console.error("砖 拽转 专  转拽:", e));
                return;
              }
              
              //  注 专 驻专 砖 砖转砖 专
              if (lobby.isPrivate && lobby.creator !== currentUserNickname) {
                return;
              }
              
              //  砖注专 砖拽 转拽
              let players = [];
              if (lobby.players && Array.isArray(lobby.players)) {
                players = lobby.players;
              } else if (lobby.creator) {
                players = [lobby.creator];
              }
              
              // 拽  砖转砖  爪专  砖转转祝 专
              const isParticipant = players.includes(currentUserNickname);
              const isCreator = lobby.creator === currentUserNickname;
              
              // 专 转 砖砖转砖  爪专
              if (lobby.status === 'waiting' && !isCreator && !lobby.isPrivate) {
                openLobbies.push({ lobbyId, creator: lobby.creator, timestamp: lobby.createdAt });
              } 
              // 专 驻注 砖砖转砖 砖转转祝 
              else if (lobby.status === 'full' && isParticipant) {
                activeGames.push({ lobbyId, isCreator });
              } 
              // 专 砖砖转砖 爪专  转
              else if (isCreator && lobby.status === 'waiting') {
                userLobbies.push({ 
                  lobbyId, 
                  private: lobby.isPrivate, 
                  timestamp: lobby.createdAt 
                });
              } 
            } catch (error) {
              console.error("砖 注 专:", error);
            }
          });
          
          console.log(`爪 ${openLobbies.length} 专 驻转, ${userLobbies.length} 专 砖 砖转砖, ${activeGames.length} 砖拽 驻注`);
          
          //  专 驻  爪专
          openLobbies.sort((a, b) => b.timestamp - a.timestamp);
          userLobbies.sort((a, b) => b.timestamp - a.timestamp);
          
          // 爪转 专 驻转
          if (openLobbies.length > 0) {
            lobbiesDiv.innerHTML += '<h3>专 驻转 爪专驻转</h3>';
            openLobbies.forEach(lobby => {
              const lobbyTime = new Date(lobby.timestamp || Date.now()).toLocaleTimeString();
              lobbiesDiv.innerHTML += `
                <div class="lobby-card">
                  <p>${lobby.creator} 转 砖拽 - 爪专 -${lobbyTime}</p>
                  <button class="btn-primary" onclick="joinLobby('${lobby.lobbyId}')">爪专祝</button>
                </div>`;
            });
          } else {
            lobbiesDiv.innerHTML += '<p> 专 驻转 专注 爪专驻转</p>';
          }
          
          // 爪 专 砖 砖转砖
          if (userLobbies.length > 0) {
            lobbiesDiv.innerHTML += `<h3>专 砖</h3>`;
            userLobbies.forEach(lobby => {
              const lobbyTime = new Date(lobby.timestamp || Date.now()).toLocaleTimeString();
              const privacyText = lobby.private ? '驻专' : '爪专';
              lobbiesDiv.innerHTML += `
                <div class="lobby-card">
                  <p>爪专转 专 ${privacyText} -${lobbyTime}</p>
                  <button class="btn-danger" onclick="cancelLobby('${lobby.lobbyId}')"> 专</button>
                </div>`;
            });
          }
          
          // 转 砖拽 驻注
          if (activeGames.length > 0) {
            console.log(`砖转砖 ${currentUserNickname} 砖转转祝 砖拽 ${activeGames[0].lobbyId} 砖转 注砖`);
            
            // 拽 专 驻 转转 砖拽 砖
            stopGameTimers();
            
            // 驻住 转爪转 专
            document.getElementById('timerDisplay').textContent = ': 00:00';
            
            // 转转 砖拽
            startGame(activeGames[0].lobbyId);
          }
        }, (error) => {
          console.error("砖 注转 专:", error);
          lobbiesDiv.innerHTML = '<p>砖 注转 专. 住 专注 转 祝</p>';
        });
      });
    }
    
    // 驻拽爪  专
    function cancelLobby(lobbyId) {
      realtimeDb.ref('lobbies/' + lobbyId).remove()
        .then(() => {
          console.log("专 拽 爪");
          
          // 拽 转 拽砖专转 专 
          realtimeDb.ref('invites').orderByChild('lobbyId').equalTo(lobbyId).once('value', snapshot => {
            if (snapshot.exists()) {
              const updates = {};
              snapshot.forEach(child => {
                updates[child.key] = null;
              });
              realtimeDb.ref('invites').update(updates);
            }
          });
          
          // 注 专砖转 专 转
          realtimeDb.ref('global_updates/lobbies').set(Date.now());
        })
        .catch((error) => {
          console.error("砖 拽转 专:", error);
          alert("砖 拽转 专: " + error.message);
        });
    }

    function createLobby() {
      if (!currentUserNickname) return alert("  注 注");
      const word = prompt("专    砖拽 (专拽 转转 注专转 专):");
      if (!word || !/^[-转祝抓 ]+$/.test(word)) return alert("  转拽");
      
      // 拽 砖砖转砖  爪专 转专  专
      realtimeDb.ref('lobbies').once('value')
        .then((snapshot) => {
          let userRoomCount = 0;
          if (snapshot.exists()) {
            snapshot.forEach((child) => {
              const room = child.val();
              if (room && room.creator === currentUserNickname) {
                userRoomCount++;
              }
            });
          }
          
          if (userRoomCount >= 3) {
            return alert("砖  专 " + userRoomCount + " 专 驻转. 拽 转 专 砖 驻 爪专转 砖.");
          }
          
          // 拽转 专 砖专转
          return realtimeDb.ref('.info/connected').once('value');
        })
        .then((snapshot) => {
          if (!snapshot || snapshot.val() !== true) {
            throw new Error(" 专 砖专转");
          }
          
          console.log("专 砖专转 - 砖 爪专转 专");
          
          // 爪专转  专 砖
          const lobbyRef = realtimeDb.ref('lobbies').push();
          const lobbyId = lobbyRef.key;
          
          if (!lobbyId) {
            throw new Error("砖:  转 爪专  专");
          }
          
          // 爪专转 拽 专
          const newLobby = {
            creator: currentUserNickname,
            status: 'waiting',
            players: [currentUserNickname],
            word: word.toLowerCase(),
            guesses: [],
            mistakes: 0,
            chat: [],
            lastUpdate: firebase.database.ServerValue.TIMESTAMP,
            createdAt: firebase.database.ServerValue.TIMESTAMP
          };
          
          // 注 专 住
          return lobbyRef.set(newLobby);
        })
        .then(() => {
          // 注 专砖转 专 转
          realtimeDb.ref('lobbies_list').set({
            lastUpdate: firebase.database.ServerValue.TIMESTAMP,
            updateCount: firebase.database.ServerValue.increment(1)
          });
          
          // 专  砖转砖 专注 转 专砖转 专
          realtimeDb.ref('global_updates/lobbies').set(Date.now());
          
          alert('专 爪专! 转 砖拽 砖...');
          console.log("专 爪专 爪");
          
          // 注 砖 转 专砖转 专 砖转砖 
          loadLobbies();
        })
        .catch((error) => {
          console.error("砖 爪专转 专:", error);
          alert("砖 爪专转 专: " + error.message);
        });
    }

    function joinLobby(lobbyId, isFromInvite = false) {
      if (!currentUserNickname) return alert("  注 注");
      
      console.log(`住 爪专祝 专 ${lobbyId}`);
      
      // 注 爪转 驻转 - 住祝  "爪专祝"
      if (window.joiningLobby) {
        console.log("专 转爪注 转 爪专驻转 专");
        return;
      }
      
      window.joiningLobby = true;
      
      // 爪 注转 注
      document.getElementById('lobbies').innerHTML = '<div class="loader"></div><p>爪专祝 专...</p>';
      
      // 拽 专 拽 拽注转 专 砖
      if (joinTransactionTimeout) {
        clearTimeout(joinTransactionTimeout);
        joinTransactionTimeout = null;
      }
      
      // 专 转  砖驻注   转拽注 爪注
      joinTransactionTimeout = setTimeout(() => {
        console.log("专  - 专注 转拽 爪专驻转 专");
        window.joiningLobby = false;
        currentLobbyId = null;
        
        // 住 专 转 砖转砖 爪 转转
        document.getElementById('gameContainer').classList.add('hidden');
        document.getElementById('homeContainer').classList.remove('hidden');
        
        // 注 砖 转 
        loadLobbies();
      }, 15000); // 15 砖转  
      
      // 拽转 专 砖专转 转
      realtimeDb.ref('.info/connected').once('value')
        .then((connSnapshot) => {
          if (!connSnapshot || connSnapshot.val() !== true) {
            throw new Error(" 专 砖专转");
          }
          
          // 拽 砖专 拽 驻 爪专驻转
          return realtimeDb.ref('lobbies/' + lobbyId).once('value');
        })
        .then((snapshot) => {
          if (!snapshot.exists()) {
            console.log("专  爪");
            alert("专  爪 转专");
            throw new Error("专  爪");
          }
          
          const lobby = snapshot.val();
          
          if (lobby.status !== 'waiting') {
            console.log("专  爪 转");
            alert("专 专    转");
            throw new Error("专  爪 转");
          }
          
          //  砖转  爪专 专
          if (lobby.creator === currentUserNickname) {
            console.log("转 爪专 专,  转 爪专祝");
            alert(" 专 砖, 转 专 转");
            throw new Error("转 爪专 专");
          }
          
          // 转转 注 专
          console.log("转 转 爪专驻转 专");
          
          // 注 住住 专 专转 砖砖转砖 住祝 住 爪专祝
          return realtimeDb.ref('lobbies/' + lobbyId).update({
            joining_attempt: {
              user: currentUserNickname,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            }
          });
        })
        .then(() => {
          // 拽 住驻转 砖专 拽 转拽
          return realtimeDb.ref('lobbies/' + lobbyId).once('value');
        })
        .then(snapshot => {
          if (!snapshot.exists()) {
            throw new Error("专  爪 转专");
          }
          
          const currentLobby = snapshot.val();
          
          if (currentLobby.status !== 'waiting') {
            throw new Error("专 专  爪 转");
          }
          
          //  砖砖拽 转 
          let players = [];
          if (Array.isArray(currentLobby.players)) {
            players = [...currentLobby.players];
          } else if (currentLobby.creator) {
            players = [currentLobby.creator];
          }
          
          //  砖砖拽  拽 专
          if (!players.includes(currentUserNickname)) {
            players.push(currentUserNickname);
          }
          
          // 注 转 爪'
          let chat = [];
          if (Array.isArray(currentLobby.chat)) {
            chat = [...currentLobby.chat];
          } else {
            chat = [];
          }
          
          // 住祝 注转 注专转
          chat.push({
            nickname: '注专转',
            text: `${currentUserNickname} 爪专祝 砖拽!`,
            timestamp: Date.now()
          });
          
          console.log("注 转 专 注 住住 -'full'");
          
          // 注 转 专 驻 砖专 -  拽专 爪转 爪专驻转
          return realtimeDb.ref('lobbies/' + lobbyId).update({
            status: 'full',
            players: players,
            chat: chat,
            gameStarted: true,
            lastUpdate: firebase.database.ServerValue.TIMESTAMP
          });
        })
        .then(() => {
          console.log("注 专 爪, 砖专  专 ");
          
          // 砖专转  专  砖 驻 转转 砖拽
          currentLobbyId = lobbyId;
          
          console.log("爪专驻转 专 爪!");
          
          // 注 转 专砖转 专 转
          return realtimeDb.ref('global_updates/lobbies').set(Date.now());
        })
        .then(() => {
          console.log("专转 转爪转 砖拽");
          
          // 注专 住 砖拽
          document.getElementById('homeContainer').classList.add('hidden');
          document.getElementById('gameContainer').classList.remove('hidden');
          
          // 转 转 砖拽 - 砖 驻注 转  驻专 专 注 拽
          console.log("转 砖拽...");
          
          // 拽 专 转
          if (joinTransactionTimeout) {
            clearTimeout(joinTransactionTimeout);
            joinTransactionTimeout = null;
          }
          
          // 驻专  驻 驻注转 startGame - 注 爪 转拽注
          setTimeout(() => {
            console.log("驻注 startGame 注 ID:", lobbyId);
            startGame(lobbyId);
            
            // 驻住  爪专驻转
            window.joiningLobby = false;
          }, 500);
        })
        .catch((error) => {
          // 拽 专 转
          if (joinTransactionTimeout) {
            clearTimeout(joinTransactionTimeout);
            joinTransactionTimeout = null;
          }
          
          console.error("砖 爪专驻转 砖拽:", error);
          
          // 驻住  爪专驻转
          window.joiningLobby = false;
          currentLobbyId = null;
          
          if (!["专  爪", "专  爪 转", "转 爪专 专", "专 专  爪 转"].includes(error.message)) {
            alert("砖 爪专驻转 专: " + error.message);
          }
          
          // 专 砖, 专注 转 专砖转 专
          document.getElementById('gameContainer').classList.add('hidden');
          document.getElementById('homeContainer').classList.remove('hidden');
          loadLobbies();
        });
    }

    function startGame(lobbyId) {
      console.log(`转 砖拽 专 ${lobbyId}`);
      
      if (!lobbyId) {
        console.error("砖 转转 砖拽 - 住专  专");
        return;
      }
      
      //  砖  爪注 转 转转 砖拽 专
      if (window.startingGame) {
        console.log("专 转爪注 转 转转 砖拽");
        return;
      }
      
      window.startingGame = true;
      
      // 拽 专 拽 - 砖  砖拽
      stopGameTimers();
      
      // 驻住 转爪转 专 
      document.getElementById('timerDisplay').textContent = ': 00:00';
      
      // 爪专转 专 转 转 转转 砖拽
      const startGameTimeout = setTimeout(() => {
        console.log("  转 转转 砖拽");
        window.startingGame = false;
        window.joiningLobby = false;
        
        // 专 住 转 拽专 砖 转拽注
        document.getElementById('gameContainer').classList.add('hidden');
        document.getElementById('homeContainer').classList.remove('hidden');
        loadLobbies();
      }, 10000);
      
      //  砖专 拽 驻 转转 砖拽
      realtimeDb.ref('lobbies/' + lobbyId).once('value')
        .then((snapshot) => {
          if (!snapshot.exists()) {
            console.error("专  爪 转转 砖拽");
            throw new Error("专  爪 转专");
          }
          
          console.log("专 爪, 砖 转转 砖拽");
          
          // 砖专转  专 
          currentLobbyId = lobbyId;
          
          // 注专 住 砖拽
          document.getElementById('homeContainer').classList.add('hidden');
          document.getElementById('gameContainer').classList.remove('hidden');
          
          // 驻住 拽住
          const canvas = document.getElementById('hangmanCanvas');
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          
          // 驻住 转爪转 拽
          document.getElementById('scoreDisplay').textContent = '拽: 0';
          
          // 拽  专 砖拽 爪专祝  专
          const lobby = snapshot.val();
          const isJoiner = lobby.creator !== currentUserNickname;
          
          console.log("住住: " + (isJoiner ? "砖拽 爪专祝" : "砖拽 专"));
          
          // 注转 爪 砖拽 - 砖 驻 转转 专
          loadGameState(lobbyId);
          
          // 转 专 砖拽 砖 (专拽 砖拽 砖)
          if (isJoiner) {
            console.log("转 专 砖拽 砖拽 爪专祝");
            startGameTimer();
          }
          
          // 注 爪 砖拽 住
          return realtimeDb.ref('lobbies/' + lobbyId).update({
            gameStarted: true,
            status: 'active', // 住 砖砖拽 驻注
            lastUpdate: firebase.database.ServerValue.TIMESTAMP
          });
        })
        .then(() => {
          console.log("砖拽 转 爪");
          
          // 拽 专 转
          clearTimeout(startGameTimeout);
          
          // 驻住 砖转 爪
          window.startingGame = false;
          window.joiningLobby = false;
        })
        .catch((error) => {
          console.error("砖 转转 砖拽:", error);
          
          // 拽 专 转
          clearTimeout(startGameTimeout);
          
          // 驻住 砖转
          window.startingGame = false;
          window.joiningLobby = false;
          
          if (joinTransactionTimeout) {
            clearTimeout(joinTransactionTimeout);
            joinTransactionTimeout = null;
          }
          
          // 转拽 转 拽专 砖 砖
          realtimeDb.ref('lobbies/' + lobbyId).off();
          
          alert("砖 注转 砖拽: " + error.message);
          
          // 专 住 转 拽专 砖 砖
          document.getElementById('gameContainer').classList.add('hidden');
          document.getElementById('homeContainer').classList.remove('hidden');
          
          // 专注 专砖转 专
          loadLobbies();
        });
    }

    function loadGameState(lobbyId) {
      console.log(`注 爪 砖拽 注专 专 ${lobbyId}`);
      
      if (!lobbyId) {
        console.error("  专 注转 爪 砖拽");
        return;
      }
      
      const canvas = document.getElementById('hangmanCanvas');
      const ctx = canvas.getContext('2d');
      
      // 拽 爪 拽
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById('wordDisplay').textContent = '';
      document.getElementById('gameStatus').textContent = '注 砖拽...';
      
      // 转拽 转 拽转 爪专转  砖
      realtimeDb.ref('lobbies/' + lobbyId).off();
      
      // 拽 专砖转  专 拽
      realtimeDb.ref('lobbies/' + lobbyId).once('value')
        .then((snapshot) => {
          if (!snapshot.exists()) {
            console.error("专  拽 注转 注转 爪 砖拽");
            document.getElementById('gameStatus').textContent = "专  拽";
            setTimeout(() => exitGame(), 2000);
            return;
          }
          
          console.log("专 爪, 专  爪 砖拽");
          
          // 爪专转  转砖转 爪 砖拽
          realtimeDb.ref('lobbies/' + lobbyId).on('value', (snapshot) => {
            const lobby = snapshot.val();
            if (!lobby) {
              document.getElementById('gameStatus').textContent = "专 拽";
              // 专 住 转  专  拽
              setTimeout(() => {
                exitGame();
              }, 3000);
              return;
            }
        
        //  砖砖拽  专 砖拽 驻注
        if (lobby.status !== 'full' && lobby.status !== 'active') {
          console.log("爪 专  转拽:", lobby.status);
          document.getElementById('gameStatus').textContent = "爪 专  转拽, 专 祝 转...";
          setTimeout(() => {
            exitGame();
          }, 3000);
          return;
        }

        const word = lobby.word;
        const guesses = Array.isArray(lobby.guesses) ? lobby.guesses : [];
        const mistakes = lobby.mistakes || 0;
        const isCreator = lobby.creator === currentUserNickname;
        
        // 注 转爪转 注转
        document.getElementById('mistakesCount').textContent = `注转: ${mistakes}/10`;

        // 爪转 
        let display = '';
        for (let char of word) {
          display += guesses.includes(char) ? char + ' ' : (char === ' ' ? '  ' : '_ ');
        }
        document.getElementById('wordDisplay').textContent = display.trim();

        // 爪专 砖 转
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#2c3e50';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        // 砖驻专 爪专 砖 转
        if (mistakes >= 1) { ctx.moveTo(50, 180); ctx.lineTo(150, 180); }  // 住住
        if (mistakes >= 2) { ctx.moveTo(100, 180); ctx.lineTo(100, 20); }  // 注 
        if (mistakes >= 3) { ctx.moveTo(100, 20); ctx.lineTo(140, 20); }   // 注 驻拽
        if (mistakes >= 4) { ctx.moveTo(140, 20); ctx.lineTo(140, 40); }   // 
        if (mistakes >= 5) {                                              // 专砖
          ctx.moveTo(140, 60);
          ctx.arc(140, 60, 20, 0, Math.PI * 2);
        }
        if (mistakes >= 6) { ctx.moveTo(140, 80); ctx.lineTo(140, 120); } // 祝
        if (mistakes >= 7) { ctx.moveTo(140, 90); ctx.lineTo(120, 110); } //  砖
        if (mistakes >= 8) { ctx.moveTo(140, 90); ctx.lineTo(160, 110); } //  
        if (mistakes >= 9) { ctx.moveTo(140, 120); ctx.lineTo(120, 150); } // 专 砖
        if (mistakes >= 10) { ctx.moveTo(140, 120); ctx.lineTo(160, 150); } // 专 
        ctx.stroke();

        // 注 拽转
        const keyboard = document.getElementById('keyboard');
        keyboard.innerHTML = '';
        const hebrewAlphabet = '住注驻爪拽专砖转祝抓';
        const isGameOver = mistakes >= 10 || !display.includes('_');
        
        // 专拽 砖拽 砖  砖转砖 拽转
        if (!isCreator && !isGameOver) {
          for (let letter of hebrewAlphabet) {
            if (!guesses.includes(letter)) {
              const btn = document.createElement('button');
              btn.textContent = letter;
              btn.onclick = () => guessLetter(lobbyId, letter);
              keyboard.appendChild(btn);
            }
          }
        }

        // 注 住住 砖拽
        if (isCreator) {
          const otherPlayer = lobby.players && lobby.players.length > 1 ? lobby.players[1] : "砖拽 砖";
          document.getElementById('gameStatus').textContent = 
            ` -${otherPlayer} 砖 转 : ${word}`;
        } else {
          if (mistakes >= 10) {
            document.getElementById('gameStatus').textContent = `驻住转!  转: ${word}`;
            playSound('loseSound');
            stopGameTimers();
          } else if (!display.includes('_')) {
            document.getElementById('gameStatus').textContent = '爪转!  !';
            playSound('winSound');
            stopGameTimers();
          } else {
            document.getElementById('gameStatus').textContent = `砖 转 `;
          }
          
          // 注 拽 砖砖拽 住转
          if (isGameOver && !isCreator) {
            let baseScore = 0;
            if (!display.includes('_')) {  // 爪
              baseScore = 10 - mistakes;  // 10 拽转 住住 驻转 注转
              
              // 住 专转 -  砖专转 专 转专, 转专 拽转
              const timeBonus = Math.max(0, 5 - Math.floor(gameTimeTaken / 30));
              
              currentRoundScore = baseScore + timeBonus;
              document.getElementById('scoreDisplay').textContent = `拽: ${currentRoundScore}`;
              
              updateScore(currentRoundScore, gameTimeTaken);
            } else {  // 驻住
              document.getElementById('scoreDisplay').textContent = `拽: 0`;
              updateScore(0, gameTimeTaken);
            }
          }
        }

        // 注 爪'
        const chat = document.getElementById('chat');
        chat.innerHTML = '';
        if (lobby.chat && Array.isArray(lobby.chat) && lobby.chat.length > 0) {
          lobby.chat.slice(-15).forEach(msg => {
            if (!msg || !msg.nickname) return;
            
            const isSystem = msg.nickname === '注专转';
            const isOther = msg.nickname !== currentUserNickname && !isSystem;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = isSystem ? 'chat-message system' : 
                                  isOther ? 'chat-message other' : 'chat-message';
            
            if (!isSystem) {
              const nameSpan = document.createElement('div');
              nameSpan.className = isOther ? 'chat-name other' : 'chat-name';
              nameSpan.textContent = msg.nickname;
              messageDiv.appendChild(nameSpan);
            }
            
            const textSpan = document.createElement('div');
            textSpan.textContent = msg.text;
            messageDiv.appendChild(textSpan);
            
            chat.appendChild(messageDiv);
          });
          chat.scrollTop = chat.scrollHeight;
        }
      }, (error) => {
            console.error("砖 注转 砖拽:", error);
            document.getElementById('gameStatus').textContent = "砖 注转 砖拽";
            setTimeout(() => exitGame(), 3000);
          });
        })
        .catch((error) => {
          console.error("砖 拽转 拽 专:", error);
          document.getElementById('gameStatus').textContent = "砖 注转 砖拽";
          setTimeout(() => exitGame(), 3000);
        });
    }

    function guessLetter(lobbyId, letter) {
      if (!letter) return;
      
      // 转 专 转 转
      startLetterTimer(letter);
      
      // 拽 砖 专 拽
      if (!lobbyId) {
        console.error("  专 砖转 砖");
        return;
      }
      
      console.log("砖 砖:", letter, "专:", lobbyId);
      
      realtimeDb.ref('lobbies/' + lobbyId).transaction((lobby) => {
        if (!lobby) {
          console.error("专  拽");
          return null;
        }
        
        // 拽 砖砖拽 驻注 砖砖转砖  砖 ( 爪专)
        if ((lobby.status === 'full' || lobby.status === 'active') && lobby.creator !== currentUserNickname) {
          //  砖注专 转 拽
          lobby.guesses = Array.isArray(lobby.guesses) ? lobby.guesses : [];
          
          if (!lobby.guesses.includes(letter)) {
            // 住祝 转 转 专砖转 砖
            lobby.guesses.push(letter);
            
            // 拽  转 拽转 
            if (!lobby.word || typeof lobby.word !== 'string') {
              console.error(" 住专   转拽");
            } else if (!lobby.word.includes(letter)) {
              lobby.mistakes = (lobby.mistakes || 0) + 1;
              // 爪 驻注 注转 拽转 注,  
            } else {
              // 爪 驻注 注转 拽转 注,  
            }
            
            // 注 转  注 专
            lobby.lastUpdate = firebase.database.ServerValue.TIMESTAMP;
          }
        } else {
          console.log(" 转 砖 -  砖砖拽  驻注  砖转 爪专 专");
        }
        
        return lobby;
      }).then(() => {
        // 注爪专 专 转 转 专 砖注住拽 住转
        stopLetterTimer(letter);
      }).catch((error) => {
        console.error("砖 砖:", error);
        stopLetterTimer(letter);
      });
    }

    function sendChat() {
      const message = document.getElementById('chatInput').value.trim();
      if (!message) {
        console.log(" 注 住祝");
        return;
      }
      
      if (!currentLobbyId) {
        console.log(" 爪  专 ");
        return;
      }
      
      if (!currentUserNickname) {
        console.log(" 爪  砖转砖 ");
        return;
      }
      
      console.log(`砖 注 专 ${currentLobbyId}`);
      
      // 拽 转 注专 爪' 
      realtimeDb.ref('lobbies/' + currentLobbyId + '/chat').once('value')
        .then((snapshot) => {
          let chatArray = [];
          
          if (snapshot.exists() && Array.isArray(snapshot.val())) {
            chatArray = snapshot.val();
          }
          
          // 住祝 转 注 砖
          const newMessage = {
            nickname: currentUserNickname,
            text: message,
            timestamp: Date.now()
          };
          
          chatArray.push(newMessage);
          console.log("注 住驻 注专 爪'");
          
          //  转  爪' -50 注转
          if (chatArray.length > 50) {
            chatArray = chatArray.slice(-50);
          }
          
          // 注 转 注专 住
          return realtimeDb.ref('lobbies/' + currentLobbyId).update({
            chat: chatArray
          });
        })
        .then(() => {
          console.log("爪' 注 爪");
          document.getElementById('chatInput').value = '';
        })
        .catch((error) => {
          console.error("砖 砖转 注:", error);
          alert("砖 砖转 注: " + error.message);
        });
    }
    
    // 住祝  专注 驻转专 Enter 砖 爪'
    document.addEventListener('DOMContentLoaded', function() {
      const chatInput = document.getElementById('chatInput');
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendChat();
        }
      });
    });

    function updateScore(points, timeTaken) {
      const user = auth.currentUser;
      if (!user) return;
      
      // 拽 转 转 砖转砖 拽
      db.collection('users').doc(user.uid).get()
        .then((doc) => {
          if (doc.exists) {
            const userData = doc.data();
            const currentScore = userData.score || 0;
            const gamesPlayed = userData.games_played || 0;
            const totalTime = (userData.avg_time || 0) * gamesPlayed;
            
            // 砖 爪注  砖
            const newGamesPlayed = gamesPlayed + 1;
            const newTotalTime = totalTime + timeTaken;
            const newAvgTime = newGamesPlayed > 0 ? newTotalTime / newGamesPlayed : 0;
            
            console.log(`注 拽: ${points} 拽转, : ${timeTaken} 砖转`);
            
            // 注 转 砖转砖
            return db.collection('users').doc(user.uid).update({
              score: currentScore + points,
              games_played: newGamesPlayed,
              avg_time: newAvgTime,
              last_game_score: points,
              last_game_time: timeTaken,
              last_updated: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        })
        .then(() => {
          // 专注 转  专 注 拽
          console.log("拽 注, 专注 转 ");
          
          // 砖 拽爪专 驻砖专 砖专转 注 转 转
          setTimeout(() => {
            loadLeaderboard();
          }, 1000);
          
          // 注 砖转砖
          const currentPoints = points > 0 ? 
            ` ! 拽转 ${points} 拽转!` : 
            `砖拽 住转,  拽转 拽转 驻注.`;
          
          document.getElementById('gameStatus').textContent += ` ${currentPoints}`;
        })
        .catch((error) => console.error("砖 注 拽:", error));
    }

    function exitGame() {
      if (!currentLobbyId) {
        document.getElementById('gameContainer').classList.add('hidden');
        document.getElementById('homeContainer').classList.remove('hidden');
        return;
      }
      
      // 拽 专
      stopGameTimers();
      
      // 转拽 转
      realtimeDb.ref('lobbies/' + currentLobbyId).off();
      
      // 拽  砖转砖  爪专 专
      realtimeDb.ref('lobbies/' + currentLobbyId).once('value')
        .then((snapshot) => {
          if (snapshot.exists()) {
            const lobby = snapshot.val();
            
            //  砖转砖  爪专 专, 拽 转
            if (lobby.creator === currentUserNickname) {
              return realtimeDb.ref('lobbies/' + currentLobbyId).remove();
            } 
            // 专转, 注 转 专
            else if (lobby.players && Array.isArray(lobby.players)) {
              const updatedPlayers = lobby.players.filter(player => player !== currentUserNickname);
              
              // 住祝 注转 注专转 注 注
              let chatArray = Array.isArray(lobby.chat) ? [...lobby.chat] : [];
              chatArray.push({
                nickname: '注专转',
                text: `${currentUserNickname} 注 转 砖拽`,
                timestamp: Date.now()
              });
              
              return realtimeDb.ref('lobbies/' + currentLobbyId).update({
                players: updatedPlayers,
                chat: chatArray,
                status: 'ended'  // 砖拽 住转
              });
            }
          }
        })
        .catch((error) => console.error("砖 爪 砖拽:", error))
        .finally(() => {
          currentLobbyId = null;
          document.getElementById('gameContainer').classList.add('hidden');
          document.getElementById('homeContainer').classList.remove('hidden');
          
          // 专注 专砖转 专
          realtimeDb.ref('global_updates/lobbies').set(Date.now());
          loadLobbies();
        });
    }
  </script>
</body>
</html>
